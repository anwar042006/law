<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🔐 Blockchain Evidence Tracking System</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen font-sans">

<!-- LOGIN PAGE -->
<div id="loginPage" class="flex items-center justify-center min-h-screen p-4">
  <div class="w-full max-w-md bg-white rounded-2xl shadow-lg p-6">
    <div class="text-center mb-4">
      <h1 class="text-2xl font-bold">🔐 Evidence Tracking</h1>
      <p class="text-sm text-gray-500 mt-1">Select your role to continue</p>
    </div>
    <div class="grid gap-3 mb-4">
      <button onclick="selectRole('Police')" class="w-full py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">👮 Police</button>
      <button onclick="selectRole('Court')" class="w-full py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700">🏛️ Court</button>
      <button onclick="selectRole('Public')" class="w-full py-2 rounded-lg bg-green-600 text-white hover:bg-green-700">👥 Public</button>
    </div>
    <div id="loginForm" class="hidden space-y-3">
      <input id="username" placeholder="Username" class="w-full border p-2 rounded" />
      <input id="password" placeholder="Password" type="password" class="w-full border p-2 rounded" />
      <button onclick="login()" class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">Login & Connect Wallet</button>
    </div>
    <div id="walletConnectLogin" class="hidden space-y-3">
      <button onclick="connectWallet()" class="w-full bg-yellow-400 text-black py-2 rounded hover:brightness-95">Connect Wallet 🦊</button>
      <p class="text-xs text-gray-500 break-words">Public users can view cases (read-only).</p>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden flex h-screen">
  <!-- SIDEBAR -->
  <aside class="w-72 bg-gray-900 text-white flex flex-col">
    <div class="px-6 py-4 border-b border-gray-800 flex flex-col gap-1">
      <div class="text-xl font-bold">📁 Evidence Dashboard</div>
      <div id="userRoleDisplay" class="text-sm text-gray-400"></div>
      <div id="connectedAddressSidebar" class="text-xs text-gray-300 break-words"></div>
    </div>
    <nav class="flex-1 px-2 py-4 space-y-1">
      <button onclick="showTab('dashboardTab')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-800">🏠 Home</button>
      <button id="registerBtn" onclick="showTab('registerTab')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-800">📝 Register Case</button>
      <button id="judgmentBtn" onclick="showTab('judgmentTab')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-800">🏛️ Submit Judgment</button>
      <button onclick="showTab('trackingTab')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-800">🔍 Case Tracking</button>
    </nav>
    <div class="p-4 border-t border-gray-800">
      <button onclick="logout()" class="w-full bg-gray-700 py-2 rounded hover:bg-gray-600">🔑 Logout</button>
    </div>
  </aside>

  <!-- MAIN AREA -->
  <div class="flex-1 flex flex-col">
    <!-- TOP BAR -->
    <header class="flex items-center justify-between px-6 py-3 bg-white border-b border-gray-200">
      <div>
        <h2 id="pageTitle" class="text-lg font-semibold">Dashboard</h2>
        <p id="pageSubtitle" class="text-xs text-gray-500">Sidebar → Select a tab</p>
      </div>
      <div class="flex items-center gap-3">
        <div id="walletArea" class="text-sm font-mono text-gray-700">Not connected</div>
      </div>
    </header>

    <!-- CONTENT -->
    <main class="p-6 overflow-auto">

      <!-- HOME -->
      <section id="dashboardTab">
        <div class="bg-white rounded shadow p-4">
          <h3 class="font-semibold">Welcome</h3>
          <p class="text-sm text-gray-500 mt-1">Use the sidebar to navigate. Connect a wallet to perform on-chain actions.</p>
        </div>
      </section>

      <!-- REGISTER CASE -->
      <section id="registerTab" class="hidden">
        <h3 class="text-xl font-semibold mb-3">📝 Register Case</h3>
        <div class="bg-white rounded shadow p-6 max-w-3xl grid gap-3">
          <label>Aadhaar 🆔</label>
          <input id="aadhaar" maxlength="12" class="w-full border p-2 rounded" onblur="autoFillAccused()" />
          <label>Accused Name 👤</label>
          <input id="accusedName" class="w-full border p-2 rounded" />
          <label>Case Detail 📝</label>
          <textarea id="caseDetail" class="w-full border p-2 rounded"></textarea>
          <label>Crime Location 📍</label>
          <input id="crimeLocation" class="w-full border p-2 rounded" />
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label>Crime Date & Time 🕒</label>
              <input id="crimeDateTime" type="datetime-local" class="w-full border p-2 rounded" />
            </div>
            <div>
              <label>Registration Date & Time 🗓️</label>
              <input id="registrationDateTime" type="datetime-local" class="w-full border p-2 rounded" readonly />
            </div>
          </div>
          <div class="flex gap-3 mt-2">
            <button onclick="registerCase()" id="btnRegisterCase" class="flex-1 bg-blue-600 text-white py-2 rounded disabled:opacity-60">Register Case</button>
            <button onclick="clearRegisterForm()" class="flex-1 bg-gray-100 py-2 rounded">Clear</button>
          </div>
        </div>
      </section>

      <!-- JUDGMENT -->
      <section id="judgmentTab" class="hidden">
        <h3 class="text-xl font-semibold mb-3">🏛️ Submit Judgment</h3>
        <div class="bg-white rounded shadow p-6 max-w-3xl grid gap-3">
          <label>Search Evidence / Aadhaar / Accused</label>
          <select id="evidenceSelect" class="w-full border p-2 rounded" onchange="fillCaseFromSelect()">
            <option value="">-- Select Case --</option>
          </select>
          <label>Evidence ID</label>
          <input id="evidenceID_j" class="w-full border p-2 rounded" readonly />
          <label>Judgment 🏛️</label>
          <textarea id="judgmentText" class="w-full border p-2 rounded"></textarea>
          <label>Closing Date 🗓️</label>
          <input id="closingDate" type="date" class="w-full border p-2 rounded" />
          <div class="flex gap-3">
            <button onclick="submitJudgment()" id="btnSubmitJudgment" class="flex-1 bg-purple-600 text-white py-2 rounded">Submit Judgment</button>
            <button onclick="clearJudgmentForm()" class="flex-1 bg-gray-100 py-2 rounded">Clear</button>
          </div>
        </div>
      </section>

      <!-- CASE TRACKING -->
      <section id="trackingTab" class="hidden">
        <h3 class="text-xl font-semibold mb-3">🔍 Case Tracking</h3>
        <div class="bg-white rounded shadow p-4 mb-4 max-w-5xl flex gap-2">
          <input id="searchTracking" placeholder="Search Evidence / Aadhaar / Accused" class="flex-1 border p-2 rounded" />
          <button onclick="searchCase()" class="bg-green-600 text-white px-3 py-2 rounded">Search</button>
          <button onclick="fetchAllCases()" class="bg-gray-200 px-3 py-2 rounded">Refresh</button>
        </div>
        <div class="overflow-auto bg-white rounded shadow max-w-5xl">
          <table id="trackingResultsTable" class="min-w-full table-auto border-collapse hidden">
            <thead class="bg-gray-100">
              <tr>
                <th class="border p-2 text-left">Evidence ID</th>
                <th class="border p-2 text-left">Unique ID</th>
                <th class="border p-2 text-left">Aadhaar</th>
                <th class="border p-2 text-left">Accused</th>
                <th class="border p-2 text-left">Case Detail</th>
                <th class="border p-2 text-left">Location</th>
                <th class="border p-2 text-left">Crime DateTime</th>
                <th class="border p-2 text-left">Registration DateTime</th>
                <th class="border p-2 text-left">Judgment</th>
                <th class="border p-2 text-left">Closing Date</th>
              </tr>
            </thead>
            <tbody id="trackingResults"></tbody>
          </table>
          <div id="noCases" class="p-4 text-center text-gray-500 hidden">No cases found.</div>
        </div>
      </section>

    </main>
  </div>
</div>

<script>
const contractABI = [ [
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "aadhaar",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "accused",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "caseDetail",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "location",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "crimeDateTime",
				"type": "string"
			}
		],
		"name": "registerCase",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "judgmentText",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "closingDate",
				"type": "string"
			}
		],
		"name": "submitJudgment",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "allCases",
		"outputs": [
			{
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "uniqueID",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "aadhaar",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "accused",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "caseDetail",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "location",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "crimeDateTime",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "registrationDateTime",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "judgment",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "closingDate",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getAllCases",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "uniqueID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "aadhaar",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "accused",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "caseDetail",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "location",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "crimeDateTime",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "registrationDateTime",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "judgment",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "closingDate",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.Case[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			}
		],
		"name": "getCaseByEvidenceID",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "uniqueID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "aadhaar",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "accused",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "caseDetail",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "location",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "crimeDateTime",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "registrationDateTime",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "judgment",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "closingDate",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.Case",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "aadhaar",
				"type": "string"
			}
		],
		"name": "getCasesByAadhaar",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "uniqueID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "aadhaar",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "accused",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "caseDetail",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "location",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "crimeDateTime",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "registrationDateTime",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "judgment",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "closingDate",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.Case[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
]];
const contractAddress = "0xc3B3095504B859a668e73b4108820633b640493f";

let provider, signer, contract, userAddress;
let role = '';

// Hardcoded credentials
const credentials = {
  "police1": "pass123",
  "police2": "pass456",
  "court1": "court123",
  "court2": "court456"
};

function truncateAddress(a){return a.slice(0,6)+'...'+a.slice(-4);}

function selectRole(r){
  role = r;
  document.getElementById('loginPage').style.display = 'flex';
  if(r === 'Public'){
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('walletConnectLogin').style.display = 'block';
  } else {
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('walletConnectLogin').style.display = 'none';
  }
}

async function login(){
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();
  if(credentials[username] && credentials[username] === password){
    await connectWallet();
    showDashboard();
  } else {
    alert("Invalid username or password");
  }
}

async function connectWallet(){
  if(window.ethereum){
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    contract = new ethers.Contract(contractAddress, contractABI, signer);
    document.getElementById('walletArea').innerText = truncateAddress(userAddress);
    document.getElementById('connectedAddressSidebar').innerText = truncateAddress(userAddress);
    showDashboard();
  } else alert('Install MetaMask!');
}

function showDashboard(){
  document.getElementById('loginPage').style.display='none';
  document.getElementById('dashboard').style.display='flex';
  document.getElementById('userRoleDisplay').innerText = "Role: " + role;

  if(role === 'Public'){
    document.getElementById('registerBtn').style.display='none';
    document.getElementById('judgmentBtn').style.display='none';
  } else if(role.startsWith('police')){
    document.getElementById('judgmentBtn').style.display='none';
  } else if(role.startsWith('court')){
    document.getElementById('registerBtn').style.display='none';
  }

  fetchAllCases();
}

function showTab(tab){
  document.querySelectorAll('main section').forEach(s=>s.classList.add('hidden'));
  document.getElementById(tab).classList.remove('hidden');
  document.getElementById('pageTitle').innerText = tab.replace('Tab','');
}

function logout(){ location.reload(); }

/* ---------------- Register Case ---------------- */
function clearRegisterForm(){
  ['aadhaar','accusedName','caseDetail','crimeLocation','crimeDateTime'].forEach(id=>document.getElementById(id).value='');
}

async function autoFillAccused(){
  const aadhaar = document.getElementById('aadhaar').value.trim();
  if(!aadhaar || !contract) return;
  const cases = await contract.getCasesByAadhaar(aadhaar);
  if(cases.length>0){
    document.getElementById('accusedName').value = cases[cases.length-1].accused;
  }
}

async function registerCase(){
  const aadhaar = document.getElementById('aadhaar').value.trim();
  const accused = document.getElementById('accusedName').value.trim();
  const caseDetail = document.getElementById('caseDetail').value.trim();
  const location = document.getElementById('crimeLocation').value.trim();
  const crimeDateTime = document.getElementById('crimeDateTime').value;
  if(!aadhaar || !accused || !caseDetail || !location || !crimeDateTime){alert('All fields required'); return;}
  try{
    const tx = await contract.registerCase(aadhaar, accused, caseDetail, location, crimeDateTime);
    await tx.wait();
    alert('Case Registered!');
    clearRegisterForm();
    fetchAllCases();
  }catch(e){console.error(e); alert('Error registering case');}
}

/* ---------------- Judgment ---------------- */
function populateEvidenceDropdown(cases){
  const sel = document.getElementById('evidenceSelect');
  sel.innerHTML='<option value="">-- Select Case --</option>';
  cases.forEach(c=>{
    sel.innerHTML+=`<option value="${c.evidenceID}">${c.evidenceID} | ${c.accused} | ${c.aadhaar}</option>`;
  });
}

async function fillCaseFromSelect(){
  const sel = document.getElementById('evidenceSelect');
  const val = sel.value;
  if(!val) return;
  const c = await contract.getCaseByEvidenceID(val);
  document.getElementById('evidenceID_j').value=c.evidenceID;
}

async function submitJudgment(){
  const evidenceID = document.getElementById('evidenceID_j').value;
  const judgmentText = document.getElementById('judgmentText').value;
  const closingDate = document.getElementById('closingDate').value;
  if(!evidenceID || !judgmentText || !closingDate){alert('All fields required'); return;}
  try{
    const tx = await contract.submitJudgment(evidenceID, judgmentText, closingDate);
    await tx.wait();
    alert('Judgment submitted!');
    document.getElementById('judgmentText').value='';
    document.getElementById('closingDate').value='';
    fetchAllCases();
  }catch(e){console.error(e); alert('Error submitting judgment');}
}

function clearJudgmentForm(){
  document.getElementById('evidenceID_j').value='';
  document.getElementById('judgmentText').value='';
  document.getElementById('closingDate').value='';
}

/* ---------------- Tracking ---------------- */
async function fetchAllCases(){
  if(!contract) return;
  const cases = await contract.getAllCases();
  populateTrackingTable(cases);
  populateEvidenceDropdown(cases);
}

function populateTrackingTable(cases){
  const tbody = document.getElementById('trackingResults');
  tbody.innerHTML='';
  if(cases.length===0){document.getElementById('trackingResultsTable').classList.add('hidden');document.getElementById('noCases').classList.remove('hidden'); return;}
  document.getElementById('trackingResultsTable').classList.remove('hidden');
  document.getElementById('noCases').classList.add('hidden');
  cases.forEach(c=>{
    tbody.innerHTML+=`<tr>
      <td class="border p-2">${c.evidenceID}</td>
      <td class="border p-2">${c.uniqueID}</td>
      <td class="border p-2">${c.aadhaar}</td>
      <td class="border p-2">${c.accused}</td>
      <td class="border p-2">${c.caseDetail}</td>
      <td class="border p-2">${c.location}</td>
      <td class="border p-2">${c.crimeDateTime}</td>
      <td class="border p-2">${c.registrationDateTime}</td>
      <td class="border p-2">${c.judgment}</td>
      <td class="border p-2">${c.closingDate}</td>
    </tr>`;
  });
}

function searchCase(){
  const query = document.getElementById('searchTracking').value.toLowerCase();
  if(!query) return fetchAllCases();
  contract.getAllCases().then(cases=>{
    const filtered = cases.filter(c=>
      c.evidenceID.toLowerCase().includes(query)||
      c.uniqueID.toLowerCase().includes(query)||
      c.aadhaar.toLowerCase().includes(query)||
      c.accused.toLowerCase().includes(query)
    );
    populateTrackingTable(filtered);
  });
}
</script>
</body>
</html>
