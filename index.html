<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Blockchain Evidence Tracking</title>
<script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<style>
body { font-family: Arial, sans-serif; background: linear-gradient(to right,#2c3e50,#3498db); color:#fff; text-align:center; padding:20px;}
h2,h3 { margin:10px 0; }
.container { max-width:900px; margin:auto; background:#1e1e2f; padding:20px; border-radius:12px; box-shadow:0px 0px 15px rgba(0,0,0,0.5);}
label { display:block; margin:10px 0 5px; font-weight:bold; text-align:left; }
input, select, textarea { width:95%; padding:8px; margin:5px 0 15px; border-radius:6px; border:none; }
textarea { resize:vertical; }
button { padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-size:15px; font-weight:bold; }
button:hover { opacity:0.9; }
.hidden { display:none; }
.role-btn { background:#e67e22; margin:5px; color:#000; }
.logout-btn { background:#e74c3c; color:#fff; margin-top:15px; }
.track-section { background:#2c2c3c; padding:15px; border-radius:10px; margin-top:20px; text-align:left;}
.readonly { background: rgba(255,255,255,0.2); }
.case-box { background:#333; padding:10px; margin:10px 0; border-radius:8px; }
</style>
</head>
<body>

<div class="container">
<h1><i class="fas fa-balance-scale"></i> Evidence Tracking System</h1>

<!-- Role Selection -->
<div id="roleSelect">
  <h2>Select Role</h2>
  <button class="role-btn" onclick="showLogin('police')"><i class="fas fa-user-shield"></i> Police</button>
  <button class="role-btn" onclick="showLogin('court')"><i class="fas fa-gavel"></i> Court</button>
  <button class="role-btn" onclick="showPortal('public')"><i class="fas fa-globe"></i> Public</button>
</div>

<!-- Police Login -->
<div id="policeLogin" class="hidden">
  <h2><i class="fas fa-user-shield"></i> Police Login</h2>
  <input type="text" id="policeUser" placeholder="👤 Username" autocomplete="off">
  <input type="password" id="policePass" placeholder="🔑 Password" autocomplete="new-password">
  <button onclick="login('police')">Login</button>
</div>

<!-- Court Login -->
<div id="courtLogin" class="hidden">
  <h2><i class="fas fa-gavel"></i> Court Login</h2>
  <input type="text" id="courtUser" placeholder="👤 Username" autocomplete="off">
  <input type="password" id="courtPass" placeholder="🔑 Password" autocomplete="new-password">
  <button onclick="login('court')">Login</button>
</div>

<!-- Police Portal -->
<div id="policePortal" class="hidden">
<h2><i class="fas fa-user-shield"></i> Police Portal</h2>
<label>🆔 Aadhaar ID</label><input type="text" id="aadhaar">
<label>🙍 Accused Name</label><input type="text" id="accused">
<label>📂 Case Details</label><textarea id="caseDetails"></textarea>
<label>📍 Location</label><input type="text" id="location">
<label>👮 Officer Name</label><input type="text" id="officer">
<label>📅 Crime Date/Time</label><input type="datetime-local" id="crimeDate">
<label>📝 Registration Date/Time</label><input type="datetime-local" id="regDate">
<label>🔑 Unique Case ID</label><input type="text" id="uniqueCaseID" class="readonly" readonly>
<label>📦 Evidence ID</label><input type="text" id="evidenceID" class="readonly" readonly>
<button onclick="registerCase()">Register Case</button>

<div class="track-section">
<h3>🔎 Track Case</h3>
<input type="text" id="trackPolice" placeholder="Enter Evidence ID or Accused Name">
<button onclick="trackCase('police')">Track</button>
<div id="policeTrackResult"></div>
</div>

<button class="logout-btn" onclick="logout()">🚪 Logout</button>
</div>

<!-- Court Portal -->
<div id="courtPortal" class="hidden">
<h2><i class="fas fa-gavel"></i> Court Portal</h2>
<label>🔎 Search by Evidence ID or Accused Name</label>
<input type="text" id="trackCourt" placeholder="Enter Evidence ID or Accused Name">
<button onclick="searchCourt()">Search</button>
<label>📑 Select Evidence</label>
<select id="evidenceSelect"></select>
<label>📜 Judgment Text</label><textarea id="judgment"></textarea>
<label>📅 Closing Date</label><input type="date" id="closingDate">
<label>🔄 Rejudgment (if any)</label><textarea id="rejudgment"></textarea>
<button onclick="submitJudgment()">Submit Judgment</button>

<div class="track-section">
<h3>🔎 Track Case</h3>
<div id="courtTrackResult"></div>
</div>

<button class="logout-btn" onclick="logout()">🚪 Logout</button>
</div>

<!-- Public Portal -->
<div id="publicPortal" class="hidden">
<h2><i class="fas fa-globe"></i> Public Portal</h2>
<div class="track-section">
<h3>🔎 Track Case</h3>
<input type="text" id="trackPublic" placeholder="Enter Evidence ID or Accused Name">
<button onclick="trackCase('public')">Track</button>
<div id="publicTrackResult"></div>
</div>
<button class="logout-btn" onclick="logout()">🚪 Logout</button>
</div>
</div>

<script>
let accounts;
let contract;
const contractAddress = "0x8571D00358933295096829E2219d22F7f98c025E";
const abi = [
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "aadhaarId",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "accusedName",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "caseDescription",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "crimeLocation",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "officerName",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "crimeDateTime",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "registrationDateTime",
				"type": "string"
			}
		],
		"name": "registerCase",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "evidenceId",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "judgmentText",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "closingDate",
				"type": "string"
			}
		],
		"name": "submitJudgment",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "aadhaarId",
				"type": "string"
			}
		],
		"name": "trackByAccusedName",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "uniqueCaseId",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "evidenceId",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "aadhaarId",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "accusedName",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "caseDescription",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "crimeLocation",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "officerName",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "crimeDateTime",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "registrationDateTime",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.CaseDetail[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "evidenceId",
				"type": "string"
			}
		],
		"name": "trackByEvidenceId",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "uniqueCaseId",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "evidenceId",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "aadhaarId",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "accusedName",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "caseDescription",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "crimeLocation",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "officerName",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "crimeDateTime",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "registrationDateTime",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.CaseDetail",
				"name": "",
				"type": "tuple"
			},
			{
				"components": [
					{
						"internalType": "string",
						"name": "evidenceId",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "accusedName",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "judgmentText",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "closingDate",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.Judgment",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];
async function loadWeb3() {
    if(window.ethereum){
        window.web3 = new Web3(window.ethereum);
        await window.ethereum.enable();
        accounts = await web3.eth.getAccounts();
        contract = new web3.eth.Contract(abi, contractAddress);
    } else { alert("Please install MetaMask!"); }
}

function showLogin(role){
    document.getElementById('roleSelect').classList.add('hidden');
    if(role==='police') document.getElementById('policeLogin').classList.remove('hidden');
    if(role==='court') document.getElementById('courtLogin').classList.remove('hidden');
}
function showPortal(role){
    document.getElementById('roleSelect').classList.add('hidden');
    if(role==='public') document.getElementById('publicPortal').classList.remove('hidden');
}

function login(role){
    if(role==='police'){
        const username = document.getElementById('policeUser').value;
        const password = document.getElementById('policePass').value;
        if(username==='police1' && password==='1234'){
            alert("✅ Police Login Successful");
            document.getElementById('policeLogin').classList.add('hidden');
            document.getElementById('policePortal').classList.remove('hidden');
        } else { alert("❌ Invalid Police credentials!"); }
    }
    if(role==='court'){
        const username = document.getElementById('courtUser').value;
        const password = document.getElementById('courtPass').value;
        if(username==='court1' && password==='1234'){
            alert("✅ Court Login Successful");
            document.getElementById('courtLogin').classList.add('hidden');
            document.getElementById('courtPortal').classList.remove('hidden');
        } else { alert("❌ Invalid Court credentials!"); }
    }
}

function logout(){
    document.querySelectorAll('#policeLogin,#courtLogin,#policePortal,#courtPortal,#publicPortal')
    .forEach(el=>el.classList.add('hidden'));
    document.getElementById('roleSelect').classList.remove('hidden');
    alert("🚪 Logged out successfully");
}

// --- POLICE: Register Case ---
async function registerCase(){
    const aadhaar=document.getElementById('aadhaar').value;
    const accused=document.getElementById('accused').value;
    const details=document.getElementById('caseDetails').value;
    const location=document.getElementById('location').value;
    const officer=document.getElementById('officer').value;
    const crimeDate=document.getElementById('crimeDate').value;
    const regDate=document.getElementById('regDate').value;

    if(!aadhaar||!accused||!details){ alert("Fill required fields"); return; }

    try{
        const tx = await contract.methods.registerCase(
            aadhaar, accused, details, location, officer, crimeDate, regDate
        ).send({from: accounts[0]});

        const uid = tx.events.CaseRegistered.returnValues.uniqueCaseID;
        const eid = tx.events.CaseRegistered.returnValues.evidenceID;
        document.getElementById('uniqueCaseID').value = uid;
        document.getElementById('evidenceID').value = eid;
        alert("✅ Case Registered (Aadhaar may already exist, linked under same IDs)");
        clearPoliceFields();
    } catch(e){ console.error(e); alert("❌ Transaction Failed"); }
}

function clearPoliceFields(){
    document.querySelectorAll('#aadhaar,#accused,#caseDetails,#location,#officer,#crimeDate,#regDate')
    .forEach(el=>el.value="");
}

// --- TRACK CASE ---
async function trackCase(role){
    const inputId = role==='police'?'trackPolice':role==='court'?'trackCourt':'trackPublic';
    const resultId = role==='police'?'policeTrackResult':role==='court'?'courtTrackResult':'publicTrackResult';
    const query = document.getElementById(inputId).value;

    const resultBox = document.getElementById(resultId);
    resultBox.innerHTML = "";

    try{
        let cases = await contract.methods.trackByEvidenceID(query).call();
        if(!Array.isArray(cases)) cases=[cases];
        displayCases(cases,resultBox);
    } catch{
        let cases2 = await contract.methods.trackByAccused(query).call();
        if(!Array.isArray(cases2)) cases2=[cases2];
        displayCases(cases2,resultBox);
    }
    document.getElementById(inputId).value="";
}

function displayCases(cases,resultBox){
    cases.forEach(c=>{
        let div=document.createElement("div");
        div.classList.add("case-box");
        div.innerHTML=`
          <b>Unique ID:</b> ${c.uniqueCaseID}<br>
          <b>Evidence ID:</b> ${c.evidenceID}<br>
          <b>Aadhaar:</b> ${c.aadhaar}<br>
          <b>Accused:</b> ${c.accused}<br>
          <b>Details:</b> ${c.details}<br>
          <b>Location:</b> ${c.location}<br>
          <b>Officer:</b> ${c.officer}<br>
          <b>Crime Date:</b> ${c.crimeDate}<br>
          <b>Registered:</b> ${c.regDate}<br>
          <b>Judgment:</b> ${c.judgment || "Pending"}
        `;
        resultBox.appendChild(div);
    });
}

// --- COURT: Search ---
async function searchCourt(){
    const query = document.getElementById('trackCourt').value;
    const resultBox=document.getElementById('courtTrackResult');
    resultBox.innerHTML="";
    try{
        let res = await contract.methods.trackByEvidenceID(query).call();
        if(!Array.isArray(res)) res=[res];
        populateEvidenceDropdown(res);
        displayCases(res,resultBox);
    } catch{
        let res2 = await contract.methods.trackByAccused(query).call();
        if(!Array.isArray(res2)) res2=[res2];
        populateEvidenceDropdown(res2);
        displayCases(res2,resultBox);
    }
    document.getElementById('trackCourt').value="";
}

function populateEvidenceDropdown(caseArray){
    const select = document.getElementById('evidenceSelect');
    select.innerHTML = "";
    caseArray.forEach(c=>{
        let opt = document.createElement('option');
        opt.value = c.evidenceID;
        opt.text = `${c.evidenceID} | ${c.accused} | ${c.uniqueCaseID}`;
        select.add(opt);
    });
}

// --- COURT: Submit Judgment ---
async function submitJudgment(){
    const eid = document.getElementById('evidenceSelect').value;
    const judgment = document.getElementById('judgment').value;
    const closingDate = document.getElementById('closingDate').value;
    const rejudgment = document.getElementById('rejudgment').value;

    if(!eid){ alert("Select Evidence"); return; }

    try{
        await contract.methods.submitJudgment(eid, judgment, closingDate, rejudgment)
        .send({from: accounts[0]});
        alert("✅ Judgment Submitted On-Chain!");
        clearCourtFields();
    } catch(e){ console.error(e); alert("❌ Transaction Failed"); }
}

function clearCourtFields(){
    document.querySelectorAll('#judgment,#closingDate,#rejudgment').forEach(el=>el.value="");
}

window.onload = loadWeb3;
</script>

</body>
</html> 
