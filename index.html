<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Blockchain Evidence Tracking</title>
<script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<style>
body { font-family: Arial, sans-serif; background: linear-gradient(to right,#2c3e50,#3498db); color:#fff; text-align:center; padding:20px;}
h2,h3 { margin:10px 0; }
.container { max-width:900px; margin:auto; background:#1e1e2f; padding:20px; border-radius:12px; box-shadow:0px 0px 15px rgba(0,0,0,0.5);}
label { display:block; margin:10px 0 5px; font-weight:bold; text-align:left; }
input, select, textarea { width:95%; padding:8px; margin:5px 0 15px; border-radius:6px; border:none; }
textarea { resize:vertical; }
button { padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-size:15px; font-weight:bold; }
button:hover { opacity:0.9; }
.hidden { display:none; }
.role-btn { background:#e67e22; margin:5px; color:#000; }
.logout-btn { background:#e74c3c; color:#fff; margin-top:15px; }
.track-section { background:#2c2c3c; padding:15px; border-radius:10px; margin-top:20px; text-align:left;}
.readonly { background: rgba(255,255,255,0.2); }
pre { white-space:pre-wrap; word-wrap:break-word; }
.small { font-size:12px; opacity:.8; }
</style>
</head>
<body>

<div class="container">
<h1><i class="fas fa-balance-scale"></i> Evidence Tracking System</h1>

<!-- Role Selection -->
<div id="roleSelect">
  <h2>Select Role</h2>
  <button class="role-btn" onclick="showLogin('police')"><i class="fas fa-user-shield"></i> Police</button>
  <button class="role-btn" onclick="showLogin('court')"><i class="fas fa-gavel"></i> Court</button>
  <button class="role-btn" onclick="showPortal('public')"><i class="fas fa-globe"></i> Public</button>
  <p class="small">Connects to MetaMask automatically when the page loads.</p>
</div>

<!-- Police Login -->
<div id="policeLogin" class="hidden">
  <h2><i class="fas fa-user-shield"></i> Police Login</h2>
  <input type="text" id="policeUser" placeholder="ğŸ‘¤ Username" autocomplete="off" inputmode="text">
  <input type="password" id="policePass" placeholder="ğŸ”‘ Password" autocomplete="new-password">
  <button onclick="login('police')">Login</button>
</div>

<!-- Court Login -->
<div id="courtLogin" class="hidden">
  <h2><i class="fas fa-gavel"></i> Court Login</h2>
  <input type="text" id="courtUser" placeholder="ğŸ‘¤ Username" autocomplete="off" inputmode="text">
  <input type="password" id="courtPass" placeholder="ğŸ”‘ Password" autocomplete="new-password">
  <button onclick="login('court')">Login</button>
</div>

<!-- Police Portal -->
<div id="policePortal" class="hidden">
<h2><i class="fas fa-user-shield"></i> Police Portal</h2>
<label>ğŸ†” Aadhaar ID</label><input type="text" id="aadhaar" autocomplete="off" inputmode="numeric" pattern="[0-9]*">
<label>ğŸ™ Accused Name</label><input type="text" id="accused" autocomplete="off">
<label>ğŸ“‚ Case Details</label><textarea id="caseDetails" autocomplete="off"></textarea>
<label>ğŸ“ Location</label><input type="text" id="location" autocomplete="off">
<label>ğŸ‘® Officer Name</label><input type="text" id="officer" autocomplete="off">
<label>ğŸ“… Crime Date/Time</label><input type="datetime-local" id="crimeDate">
<label>ğŸ“ Registration Date/Time</label><input type="datetime-local" id="regDate">
<label>ğŸ”‘ Unique Case ID</label><input type="text" id="uniqueCaseID" class="readonly" readonly>
<label>ğŸ“¦ Evidence ID</label><input type="text" id="evidenceID" class="readonly" readonly>
<button id="btnRegister" onclick="registerCase()">Register Case</button>

<div class="track-section">
<h3>ğŸ” Track Case</h3>
<input type="text" id="trackPolice" placeholder="Enter Evidence ID or Accused Name" autocomplete="off">
<button onclick="trackCase('police')">Track</button>
<pre id="policeTrackResult"></pre>
</div>

<button class="logout-btn" onclick="logout()">ğŸšª Logout</button>
</div>

<!-- Court Portal -->
<div id="courtPortal" class="hidden">
<h2><i class="fas fa-gavel"></i> Court Portal</h2>
<label>ğŸ” Search by Evidence ID or Accused Name</label>
<input type="text" id="trackCourt" placeholder="Enter Evidence ID or Accused Name" autocomplete="off">
<button onclick="searchCourt()">Search</button>
<label>ğŸ“‘ Select Evidence</label>
<select id="evidenceSelect"></select>
<label>ğŸ“œ Judgment Text</label><textarea id="judgment" autocomplete="off"></textarea>
<label>ğŸ“… Closing Date</label><input type="date" id="closingDate">
<label>ğŸ”„ Rejudgment (if any)</label><textarea id="rejudgment" autocomplete="off"></textarea>
<button id="btnSubmitJudge" onclick="submitJudgment()">Submit Judgment</button>

<div class="track-section">
<h3>ğŸ” Track Case</h3>
<pre id="courtTrackResult"></pre>
</div>

<button class="logout-btn" onclick="logout()">ğŸšª Logout</button>
</div>

<!-- Public Portal -->
<div id="publicPortal" class="hidden">
<h2><i class="fas fa-globe"></i> Public Portal</h2>
<div class="track-section">
<h3>ğŸ” Track Case</h3>
<input type="text" id="trackPublic" placeholder="Enter Evidence ID or Accused Name" autocomplete="off">
<button onclick="trackCase('public')">Track</button>
<pre id="publicTrackResult"></pre>
</div>
<button class="logout-btn" onclick="logout()">ğŸšª Logout</button>
</div>
</div>

<script>
let accounts;
let contract;

// TODO: replace with your deployed values
const contractAddress = "0xa9E9585e2B389ec648D9C0aea13868Ff6BDd2dFa";
const abi = [
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "uniqueCaseID",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "aadhaar",
				"type": "string"
			}
		],
		"name": "CaseRegistered",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			}
		],
		"name": "JudgmentSubmitted",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "aadhaar",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "accused",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "details",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "location",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "officer",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "crimeDate",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "regDate",
				"type": "string"
			}
		],
		"name": "registerCase",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "judgmentText",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "closingDate",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "rejudgment",
				"type": "string"
			}
		],
		"name": "submitJudgment",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "aadhaarCases",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"name": "aadhaarUniqueID",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "caseCounter",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"name": "cases",
		"outputs": [
			{
				"internalType": "string",
				"name": "uniqueCaseID",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "aadhaar",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "accused",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "details",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "location",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "officer",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "crimeDate",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "regDate",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "evidenceCounter",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"name": "judgments",
		"outputs": [
			{
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "judgmentText",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "closingDate",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "rejudgment",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "aadhaar",
				"type": "string"
			}
		],
		"name": "trackByAadhaar",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "uniqueCaseID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "aadhaar",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "accused",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "details",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "location",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "officer",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "crimeDate",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "regDate",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.Case[]",
				"name": "",
				"type": "tuple[]"
			},
			{
				"components": [
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "judgmentText",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "closingDate",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "rejudgment",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.Judgment[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "accusedName",
				"type": "string"
			}
		],
		"name": "trackByAccused",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "uniqueCaseID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "aadhaar",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "accused",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "details",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "location",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "officer",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "crimeDate",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "regDate",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.Case[]",
				"name": "",
				"type": "tuple[]"
			},
			{
				"components": [
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "judgmentText",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "closingDate",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "rejudgment",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.Judgment[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			}
		],
		"name": "trackByEvidenceID",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "uniqueCaseID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "aadhaar",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "accused",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "details",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "location",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "officer",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "crimeDate",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "regDate",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.Case",
				"name": "",
				"type": "tuple"
			},
			{
				"components": [
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "judgmentText",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "closingDate",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "rejudgment",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.Judgment",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

async function loadWeb3() {
  if (!window.ethereum) { alert("Please install MetaMask!"); return; }
  try {
    // Request accounts (new API)
    accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
    window.web3 = new Web3(window.ethereum);
    contract = new web3.eth.Contract(abi, contractAddress);
    console.log("Connected as", accounts[0]);
  } catch (e) {
    console.error(e);
    alert("MetaMask connection rejected.");
  }
}

function showLogin(role){
  hideAll();
  document.getElementById('roleSelect').classList.add('hidden');
  if(role==='police') document.getElementById('policeLogin').classList.remove('hidden');
  if(role==='court') document.getElementById('courtLogin').classList.remove('hidden');
}
function showPortal(role){
  hideAll();
  document.getElementById('roleSelect').classList.add('hidden');
  if(role==='public') document.getElementById('publicPortal').classList.remove('hidden');
}
function hideAll(){
  document.querySelectorAll('#policeLogin,#courtLogin,#policePortal,#courtPortal,#publicPortal')
    .forEach(el=>el.classList.add('hidden'));
}

// Simple demo logins (no storage, no persistence)
function login(role){
  if(role==='police'){
    const u = document.getElementById('policeUser').value.trim();
    const p = document.getElementById('policePass').value;
    if(u==='police1' && p==='1234'){
      alert("âœ… Police Login Successful");
      // Clear creds immediately (donâ€™t save)
      document.getElementById('policeUser').value="";
      document.getElementById('policePass').value="";
      document.getElementById('policeLogin').classList.add('hidden');
      document.getElementById('policePortal').classList.remove('hidden');
    } else {
      alert("âŒ Invalid Police credentials!");
      document.getElementById('policePass').value="";
    }
  }
  if(role==='court'){
    const u = document.getElementById('courtUser').value.trim();
    const p = document.getElementById('courtPass').value;
    if(u==='court1' && p==='1234'){
      alert("âœ… Court Login Successful");
      document.getElementById('courtUser').value="";
      document.getElementById('courtPass').value="";
      document.getElementById('courtLogin').classList.add('hidden');
      document.getElementById('courtPortal').classList.remove('hidden');
    } else {
      alert("âŒ Invalid Court credentials!");
      document.getElementById('courtPass').value="";
    }
  }
}

// LOGOUT
function logout(){
  // Clear all transient UI state
  clearPoliceFields();
  clearCourtFields();
  clearTrackOutputs();
  // Hide all portals, show role selection
  hideAll();
  document.getElementById('roleSelect').classList.remove('hidden');
  alert("ğŸšª Logged out successfully");
}
function clearTrackOutputs(){
  document.getElementById('policeTrackResult').innerText="";
  document.getElementById('courtTrackResult').innerText="";
  document.getElementById('publicTrackResult').innerText="";
  document.getElementById('trackPolice').value="";
  document.getElementById('trackCourt').value="";
  document.getElementById('trackPublic').value="";
}

// POLICE: Register Case + Aadhaar rule pre-check
async function registerCase(){
  const btn = document.getElementById('btnRegister');
  const aadhaar=document.getElementById('aadhaar').value.trim();
  const accused=document.getElementById('accused').value.trim();
  const details=document.getElementById('caseDetails').value.trim();
  const location=document.getElementById('location').value.trim();
  const officer=document.getElementById('officer').value.trim();
  const crimeDate=document.getElementById('crimeDate').value;
  const regDate=document.getElementById('regDate').value;

  if(!aadhaar||!accused||!details){
    alert("âš ï¸ Fill required fields (Aadhaar, Accused, Details)");
    return;
  }

  try{
    btn.disabled = true;

    // ===== Aadhaar rule: pre-check (if the contract exposes the getter) =====
    let existingAccused = "";
    if (contract?.methods?.getAccusedByAadhaar) {
      try {
        existingAccused = await contract.methods.getAccusedByAadhaar(aadhaar).call();
      } catch (e) {
        console.warn("getAccusedByAadhaar call failed (method may not exist). Proceeding...");
      }
    }
    if(existingAccused && existingAccused !== "" && existingAccused !== accused){
      alert("âŒ This Aadhaar is already linked to another accused. Use the same accused name or a different Aadhaar.");
      btn.disabled = false;
      return;
    }
    // =======================================================================

    const tx = await contract.methods.registerCase(
      aadhaar, accused, details, location, officer, crimeDate, regDate
    ).send({from: accounts[0]});

    // Expecting CaseRegistered event with uniqueCaseID, evidenceID
    const uid = tx?.events?.CaseRegistered?.returnValues?.uniqueCaseID || "";
    const eid = tx?.events?.CaseRegistered?.returnValues?.evidenceID || "";
    document.getElementById('uniqueCaseID').value = uid;
    document.getElementById('evidenceID').value = eid;

    alert("âœ… Case Registered On-Chain!");
    clearPoliceFields(); // auto-clear inputs (tracking input too)
  } catch(e){
    console.error(e);
    alert("âŒ Transaction Failed");
  } finally {
    btn.disabled = false;
  }
}

function clearPoliceFields(){
  document.getElementById('aadhaar').value="";
  document.getElementById('accused').value="";
  document.getElementById('caseDetails').value="";
  document.getElementById('location').value="";
  document.getElementById('officer').value="";
  document.getElementById('crimeDate').value="";
  document.getElementById('regDate').value="";
  document.getElementById('trackPolice').value="";
  // keep the generated IDs visible to copy if needed
}

// TRACK CASE (police/court/public)
async function trackCase(role){
  const inputId = role==='police'?'trackPolice':role==='court'?'trackCourt':'trackPublic';
  const resultId = role==='police'?'policeTrackResult':role==='court'?'courtTrackResult':'publicTrackResult';
  const query = document.getElementById(inputId).value.trim();

  if(!query){ alert("Enter a search term"); return; }

  try{
    let res = await contract.methods.trackByEvidenceID(query).call();
    // normalize to array if needed
    res = Array.isArray(res) ? res : [res];
    document.getElementById(resultId).innerText = JSON.stringify(res,null,2);
  } catch{
    try{
      let res2 = await contract.methods.trackByAccused(query).call();
      res2 = Array.isArray(res2) ? res2 : [res2];
      document.getElementById(resultId).innerText = JSON.stringify(res2,null,2);
    } catch (e2){
      console.error(e2);
      document.getElementById(resultId).innerText = "No results or call failed.";
    }
  } finally {
    document.getElementById(inputId).value=""; // auto-clear search box
  }
}

// COURT: Search (fills dropdown and shows results)
async function searchCourt(){
  const box = document.getElementById('trackCourt');
  const q = box.value.trim();
  if(!q){ alert("Enter search term"); return; }

  const resultBox = document.getElementById('courtTrackResult');
  try{
    let byEid = await contract.methods.trackByEvidenceID(q).call();
    byEid = Array.isArray(byEid) ? byEid : [byEid];
    populateEvidenceDropdown(byEid);
    resultBox.innerText = JSON.stringify(byEid,null,2);
  } catch {
    try {
      let byAcc = await contract.methods.trackByAccused(q).call();
      byAcc = Array.isArray(byAcc) ? byAcc : [byAcc];
      populateEvidenceDropdown(byAcc);
      resultBox.innerText = JSON.stringify(byAcc,null,2);
    } catch (e2) {
      console.error(e2);
      resultBox.innerText = "No results or call failed.";
      document.getElementById('evidenceSelect').innerHTML = "";
    }
  } finally {
    box.value=""; // auto-clear
  }
}

function populateEvidenceDropdown(caseArray){
  const select = document.getElementById('evidenceSelect');
  select.innerHTML = "";
  (caseArray || []).forEach(c=>{
    if(!c) return;
    const opt = document.createElement('option');
    opt.value = c.evidenceID || "";
    const eid = c.evidenceID || "N/A";
    const acc = c.accused || "N/A";
    const uid = c.uniqueCaseID || "N/A";
    opt.text = `${eid} | ${acc} | ${uid}`;
    select.add(opt);
  });
}

// COURT: Submit Judgment
async function submitJudgment(){
  const btn = document.getElementById('btnSubmitJudge');
  const eid = document.getElementById('evidenceSelect').value;
  const judgment = (document.getElementById('judgment').value || "").trim();
  const closingDate = document.getElementById('closingDate').value;
  const rejudgment = (document.getElementById('rejudgment').value || "").trim();

  if(!eid){ alert("Select Evidence"); return; }

  try{
    btn.disabled = true;
    await contract.methods.submitJudgment(eid, judgment, closingDate, rejudgment)
      .send({from: accounts[0]});
    alert("âœ… Judgment Submitted On-Chain!");
    clearCourtFields();
  } catch(e){
    console.error(e);
    alert("âŒ Transaction Failed");
  } finally {
    btn.disabled = false;
  }
}

function clearCourtFields(){
  document.getElementById('judgment').value="";
  document.getElementById('closingDate').value="";
  document.getElementById('rejudgment').value="";
  document.getElementById('trackCourt').value="";
}

window.addEventListener('load', loadWeb3);
</script>

</body>
</html>
