<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Blockchain Evidence Tracking â€” On-Chain</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<style>
body { font-family: Arial; background: linear-gradient(to right,#2c3e50,#3498db); color:#fff; text-align:center; padding:20px;}
h2,h3 { margin:10px 0; }
.container { max-width:920px; margin:auto; background:#1e1e2f; padding:20px; border-radius:12px; box-shadow:0px 0px 15px rgba(0,0,0,0.5);}
label { display:block; margin:10px 0 5px; font-weight:bold; text-align:left; }
input, select, textarea { width:95%; padding:8px; margin:5px 0 15px; border-radius:6px; border:none; }
textarea { resize:vertical; min-height:70px; }
button { padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-size:15px; font-weight:bold; }
button:hover { opacity:0.9; }
.hidden { display:none; }
.role-btn { background:#e67e22; margin:5px; color:#000; }
.logout-btn { background:#e74c3c; color:#fff; margin-top:15px; }
.track-section { background:#2c2c3c; padding:15px; border-radius:10px; margin-top:20px; text-align:left;}
.readonly { background: rgba(255,255,255,0.12); }
.small { font-size:12px; opacity:0.9; }
pre { background:#111; padding:10px; border-radius:8px; color:#0f0; white-space:pre-wrap; text-align:left; max-height:320px; overflow:auto; }
.flex { display:flex; gap:10px; align-items:center; justify-content:flex-start; flex-wrap:wrap; }
.pill { padding:6px 10px; border-radius:999px; background:#333; }
@media (max-width:600px){ input,select,textarea{width:100%} .container{padding:12px}}
</style>
</head>
<body>

<div class="container">
<h1><i class="fas fa-balance-scale"></i> Evidence Tracking System</h1>

<!-- Role Selection -->
<div id="roleSelect">
<h2>Select Role</h2>
<button class="role-btn" onclick="showLogin('police')"><i class="fas fa-user-shield"></i> Police</button>
<button class="role-btn" onclick="showLogin('court')"><i class="fas fa-gavel"></i> Court</button>
<button class="role-btn" onclick="showPortal('public')"><i class="fas fa-globe"></i> Public</button>
</div>

<!-- Police Login -->
<div id="policeLogin" class="hidden">
<h2><i class="fas fa-user-shield"></i> Police Login</h2>
<input type="text" id="policeUser" placeholder="Username">
<input type="password" id="policePass" placeholder="Password">
<div class="flex"><button onclick="login('police')">Login</button></div>
</div>

<!-- Court Login -->
<div id="courtLogin" class="hidden">
<h2><i class="fas fa-gavel"></i> Court Login</h2>
<input type="text" id="courtUser" placeholder="Username">
<input type="password" id="courtPass" placeholder="Password">
<div class="flex"><button onclick="login('court')">Login</button></div>
</div>

<!-- Police Portal -->
<div id="policePortal" class="hidden">
<h2><i class="fas fa-user-shield"></i> Police Portal</h2>
<label>ğŸ†” Aadhaar ID (12 digits)</label><input type="text" id="aadhaar" pattern="\d{12}" placeholder="123412341234">
<label>ğŸ‘¤ Accused Name</label><input type="text" id="accused">
<label>ğŸ“„ Case Details</label><textarea id="caseDetails"></textarea>
<label>ğŸ“ Location</label><input type="text" id="location">
<label>ğŸ‘® Officer Name</label><input type="text" id="officer">
<div class="flex">
<div style="flex:1"><label>ğŸ•’ Crime Date/Time</label><input type="datetime-local" id="crimeDate"></div>
<div style="flex:1"><label>ğŸ“ Registration Date/Time</label><input type="datetime-local" id="regDate"></div>
</div>
<button id="registerBtn" onclick="registerCaseOnChain()" disabled>Register Case</button>

<div class="track-section">
<h3>ğŸ” Track Case</h3>
<p class="small">Search by Evidence ID, Accused Name, or Aadhaar</p>
<div class="flex">
<input type="text" id="trackPolice" placeholder="Enter Evidence / Accused / Aadhaar">
<button onclick="trackCaseOnChain(document.getElementById('trackPolice').value,'police')">Track</button>
<button onclick="clearTrackResults('police')" class="pill small">Clear</button>
</div>
<pre id="policeTrackResult">{ }</pre>
</div>
<button class="logout-btn" onclick="logout()">Logout</button>
</div>

<!-- Court Portal -->
<div id="courtPortal" class="hidden">
<h2><i class="fas fa-gavel"></i> Court Portal</h2>
<label>ğŸ” Search by Evidence / Accused / Aadhaar</label>
<div class="flex">
<input type="text" id="trackCourt" placeholder="Enter Evidence / Accused / Aadhaar">
<button onclick="searchCourtOnChain()">Search</button>
<button onclick="clearTrackResults('court')" class="pill small">Clear</button>
</div>
<label>ğŸ”– Select Evidence</label><select id="evidenceSelect"></select>
<label>ğŸ“ Judgment Text</label><textarea id="judgment"></textarea>
<label>ğŸ“… Closing Date</label><input type="date" id="closingDate">
<div class="flex"><button onclick="submitJudgmentOnChain()">Submit Judgment</button><button onclick="populateAllEvidence()" class="pill small">Load Evidence</button></div>
<div class="track-section"><h3>ğŸ” Track Case</h3><pre id="courtTrackResult">{ }</pre></div>
<button class="logout-btn" onclick="logout()">Logout</button>
</div>

<!-- Public Portal -->
<div id="publicPortal" class="hidden">
<h2><i class="fas fa-globe"></i> Public Portal</h2>
<div class="track-section">
<h3>ğŸ” Track Case</h3>
<p class="small">Search by Evidence ID, Accused Name, or Aadhaar</p>
<div class="flex">
<input type="text" id="trackPublic" placeholder="Enter Evidence / Accused / Aadhaar">
<button onclick="trackCaseOnChain(document.getElementById('trackPublic').value,'public')">Track</button>
<button onclick="clearTrackResults('public')" class="pill small">Clear</button>
</div>
<pre id="publicTrackResult">{ }</pre>
</div>
<button class="logout-btn" onclick="logout()">Logout</button>
</div>

<script>
let web3;
let accounts = [0];
let contract;
const contractAddress = "0x74bFC4B516847DaF78aeFf2C7D8ff49587312181"; // Replace with deployed contract
const abi = [
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "uniqueCaseID",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "aadhaar",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "accused",
				"type": "string"
			}
		],
		"name": "CaseRegistered",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			}
		],
		"name": "JudgmentSubmitted",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "aadhaar",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "accused",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "details",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "location",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "officer",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "crimeDate",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "regDate",
				"type": "string"
			}
		],
		"name": "registerCase",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "judgmentText",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "closingDate",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "rejudgment",
				"type": "string"
			}
		],
		"name": "submitJudgment",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "aadhaarCases",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"name": "aadhaarUniqueID",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "accusedCases",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "caseCounter",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"name": "cases",
		"outputs": [
			{
				"internalType": "string",
				"name": "uniqueCaseID",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "aadhaar",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "accused",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "details",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "location",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "officer",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "crimeDate",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "regDate",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "evidenceCounter",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"name": "judgments",
		"outputs": [
			{
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "judgmentText",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "closingDate",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "rejudgment",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "aadhaar",
				"type": "string"
			}
		],
		"name": "trackByAadhaar",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "uniqueCaseID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "aadhaar",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "accused",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "details",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "location",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "officer",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "crimeDate",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "regDate",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.Case[]",
				"name": "",
				"type": "tuple[]"
			},
			{
				"components": [
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "judgmentText",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "closingDate",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "rejudgment",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.Judgment[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "accusedName",
				"type": "string"
			}
		],
		"name": "trackByAccused",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "uniqueCaseID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "aadhaar",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "accused",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "details",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "location",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "officer",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "crimeDate",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "regDate",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.Case[]",
				"name": "",
				"type": "tuple[]"
			},
			{
				"components": [
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "judgmentText",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "closingDate",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "rejudgment",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.Judgment[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			}
		],
		"name": "trackByEvidenceID",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "uniqueCaseID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "aadhaar",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "accused",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "details",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "location",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "officer",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "crimeDate",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "regDate",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.Case",
				"name": "",
				"type": "tuple"
			},
			{
				"components": [
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "judgmentText",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "closingDate",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "rejudgment",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.Judgment",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

// === Web3 Init ===
async function initWeb3() {
  if(window.ethereum){
    web3 = new Web3(window.ethereum);
    try {
      accounts = await ethereum.request({ method: 'eth_requestAccounts' });
      contract = new web3.eth.Contract(abi, contractAddress);
      console.log("Connected:", accounts[0]);
      document.getElementById('registerBtn').disabled = false;
      ethereum.on('accountsChanged', newAccounts => { accounts = newAccounts; console.log("Account changed:", accounts[0]); });
    } catch(err){ alert("MetaMask access denied"); console.error(err);}
  } else alert("Install MetaMask!");
}

window.onload = () => { initWeb3(); attachAadhaarListener(); populateAllEvidence(); };

// === Login / Logout ===
function showLogin(role){ 
  document.getElementById('roleSelect').classList.add('hidden'); 
  if(role==='police') document.getElementById('policeLogin').classList.remove('hidden'); 
  if(role==='court') document.getElementById('courtLogin').classList.remove('hidden'); 
}
function showPortal(role){ 
  document.getElementById('roleSelect').classList.add('hidden'); 
  if(role==='public') document.getElementById('publicPortal').classList.remove('hidden'); 
}
function login(role){
  if(role==='police'){ 
    const u=document.getElementById('policeUser').value.trim(); 
    const p=document.getElementById('policePass').value.trim();
    if((u==='police1'&&p==='1234')||u.startsWith('police')){ 
      alert('Police Login Successful'); 
      document.getElementById('policeLogin').classList.add('hidden'); 
      document.getElementById('policePortal').classList.remove('hidden'); 
    } else alert('Invalid credentials'); 
  }
  if(role==='court'){ 
    const u=document.getElementById('courtUser').value.trim(); 
    const p=document.getElementById('courtPass').value.trim();
    if((u==='court1'&&p==='1234')||u.startsWith('court')){ 
      alert('Court Login Successful'); 
      document.getElementById('courtLogin').classList.add('hidden'); 
      document.getElementById('courtPortal').classList.remove('hidden'); 
      populateAllEvidence(); 
    } else alert('Invalid credentials'); 
  }
}
function logout(){ 
  ['policeLogin','courtLogin','policePortal','courtPortal','publicPortal'].forEach(id=>document.getElementById(id).classList.add('hidden')); 
  document.getElementById('roleSelect').classList.remove('hidden'); 
  alert("Logged out"); 
}

// === Other functions unchanged except for fix ===
async function populateAllEvidence(){
  const sel=document.getElementById('evidenceSelect'); 
  if(!sel) return;
  const cs=await getAllCases();
  sel.innerHTML='<option value="">Select Evidence</option>';
  cs.forEach(c=> sel.innerHTML+=`<option value="${c.evidenceID}">${c.evidenceID} - ${c.accused}</option>`);
}
</script>
</body>
</html>
