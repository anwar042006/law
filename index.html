<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Evidence Tracking â€” Tabbed Sidebar Dashboard (Wallet Top-Right)</title>

<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Ethers.js -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
  /* Tiny extra styles for top-right wallet dropdown */
  .wallet-btn { min-width: 170px; }
  .tooltip { position: relative; display: inline-block; }
  .tooltip .tooltiptext {
    visibility: hidden;
    width: max-content;
    background-color: #111827;
    color: #fff;
    text-align: center;
    padding: 6px 8px;
    border-radius: 6px;
    position: absolute;
    z-index: 50;
    top: 140%;
    right: 0;
    white-space: nowrap;
    font-size: 12px;
  }
  .tooltip:hover .tooltiptext { visibility: visible; }
</style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 font-sans text-gray-900">

<!-- LOGIN PAGE -->
<div id="loginPage" class="flex items-center justify-center min-h-screen p-4">
  <div class="w-full max-w-md bg-white rounded-2xl shadow-lg p-6">
    <div class="text-center mb-4">
      <h1 class="text-2xl font-bold">ğŸ” Evidence Tracking</h1>
      <p class="text-sm text-gray-500 mt-1">Select your role to continue</p>
    </div>

    <div class="grid gap-3 mb-4">
      <button type="button" onclick="selectRole('Police')" class="w-full py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">ğŸ‘® Police</button>
      <button type="button" onclick="selectRole('Court')" class="w-full py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700">ğŸ›ï¸ Court</button>
      <button type="button" onclick="selectRole('Public')" class="w-full py-2 rounded-lg bg-green-600 text-white hover:bg-green-700">ğŸ‘¥ Public</button>
    </div>

    <div id="loginForm" class="hidden space-y-3">
      <input id="username" placeholder="Username" class="w-full border p-2 rounded" />
      <input id="password" placeholder="Password" type="password" class="w-full border p-2 rounded" />
      <button id="loginBtn" type="button" onclick="login()" class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">Login & Connect Wallet</button>
    </div>

    <div id="walletConnectLogin" class="hidden space-y-3">
      <button id="connectWalletBtnInitial" type="button" onclick="connectWallet()" class="w-full bg-yellow-400 text-black py-2 rounded hover:brightness-95">Connect Wallet ğŸ¦Š</button>
      <p id="walletAddressInitial" class="text-xs text-gray-500 break-words"></p>
      <p class="text-xs text-gray-400 mt-2">Note: Public users can view cases (read-only) if a provider is available. For on-chain writes, connect MetaMask.</p>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden flex h-screen">

  <!-- SIDEBAR -->
  <aside class="w-72 bg-gray-900 text-white flex flex-col">
    <div class="px-6 py-4 border-b border-gray-800 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="text-xl font-bold">ğŸ“ Evidence Dashboard</div>
      </div>
    </div>

    <nav class="flex-1 px-2 py-4 space-y-1">
      <button type="button" onclick="showTab('dashboardTab')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-800">ğŸ  Home</button>
      <button id="registerBtn" type="button" onclick="showTab('registerTab')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-800">ğŸ“ Register Case</button>
      <button id="judgmentBtn" type="button" onclick="showTab('judgmentTab')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-800">ğŸ›ï¸ Submit Judgment</button>
      <button type="button" onclick="showTab('trackingTab')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-800">ğŸ” Case Tracking</button>
    </nav>

    <div class="p-4 border-t border-gray-800">
      <div id="connectedAddressSidebar" class="text-xs text-gray-300 break-words mb-2"></div>
      <button id="logoutBtn" type="button" onclick="logout()" class="w-full bg-gray-700 py-2 rounded hover:bg-gray-600">ğŸ”‘ Logout</button>
    </div>
  </aside>

  <!-- MAIN AREA -->
  <div class="flex-1 flex flex-col">

    <!-- TOP BAR -->
    <header class="flex items-center justify-between px-6 py-3 bg-white border-b border-gray-200">
      <div>
        <h2 id="pageTitle" class="text-lg font-semibold">Dashboard</h2>
        <p id="pageSubtitle" class="text-xs text-gray-500">Sidebar â†’ Select a tab</p>
      </div>

      <div class="flex items-center gap-3">
        <!-- show/truncate connected wallet -->
        <div id="walletArea" class="tooltip">
          <button id="walletConnectTopBtn" type="button" class="wallet-btn inline-flex items-center gap-2 border border-gray-300 rounded px-3 py-2 text-sm bg-white hover:bg-gray-50" onclick="toggleWalletDropdown()">
            <span id="walletIcon" class="text-base">ğŸ¦Š</span>
            <span id="walletLabel" class="font-mono text-sm">Connect Wallet</span>
            <svg id="chev" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
          </button>

          <div class="tooltiptext" id="walletTooltip">Not connected</div>
        </div>

        <!-- small dropdown (hidden by default) -->
        <div id="walletDropdown" class="hidden absolute right-6 top-14 bg-white border rounded shadow-lg w-56">
          <div class="p-3 text-sm text-gray-700" id="walletFullAddr">Not connected</div>
          <div class="border-t"></div>
          <button type="button" id="disconnectBtn" onclick="disconnectWallet()" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100">Disconnect</button>
        </div>
      </div>
    </header>

    <!-- CONTENT -->
    <main class="p-6 overflow-auto">

      <!-- HOME -->
      <section id="dashboardTab">
        <div class="grid gap-4">
          <div class="bg-white rounded shadow p-4">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="font-semibold">Welcome</h3>
                <p class="text-sm text-gray-500 mt-1">Use the sidebar to navigate. Connect a wallet (top-right) to perform on-chain actions.</p>
              </div>
              <div class="text-sm text-gray-600 font-mono" id="homeWallet">Not connected</div>
            </div>
          </div>
        </div>
      </section>

      <!-- REGISTER CASE -->
      <section id="registerTab" class="hidden">
        <h3 class="text-xl font-semibold mb-3">ğŸ“ Register Case</h3>
        <div class="bg-white rounded shadow p-6 max-w-3xl">
          <div class="grid grid-cols-1 gap-3">
            <label class="text-sm">Aadhaar ğŸ†”</label>
            <input id="aadhaar" maxlength="12" class="w-full border p-2 rounded" />

            <label class="text-sm">Accused Name ğŸ‘¤</label>
            <input id="accusedName" class="w-full border p-2 rounded" />

            <label class="text-sm">Case Detail ğŸ“</label>
            <textarea id="caseDetail" class="w-full border p-2 rounded"></textarea>

            <label class="text-sm">Crime Location ğŸ“</label>
            <input id="crimeLocation" class="w-full border p-2 rounded" />

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm">Crime Date & Time ğŸ•’</label>
                <input id="crimeDateTime" type="datetime-local" class="w-full border p-2 rounded" />
              </div>
              <div>
                <label class="text-sm">Registration Date & Time ğŸ—“ï¸</label>
                <input id="registrationDateTime" type="datetime-local" class="w-full border p-2 rounded" readonly />
              </div>
            </div>

            <div class="flex gap-3 mt-2">
              <button id="btnRegisterCase" type="button" onclick="registerCase()" class="flex-1 bg-blue-600 text-white py-2 rounded disabled:opacity-60" disabled>Register Case (on-chain)</button>
              <button type="button" onclick="clearRegisterForm()" class="flex-1 bg-gray-100 py-2 rounded">Clear</button>
            </div>
          </div>
        </div>
      </section>

      <!-- SUBMIT JUDGMENT -->
      <section id="judgmentTab" class="hidden">
        <h3 class="text-xl font-semibold mb-3">ğŸ›ï¸ Submit Judgment</h3>
        <div class="bg-white rounded shadow p-6 max-w-3xl">
          <label class="text-sm">Search Evidence ID (quick)</label>
          <div class="flex gap-2 mb-3">
            <input id="searchJudgment" placeholder="EV00001" class="flex-1 border p-2 rounded" />
            <button id="btnFindCase" type="button" onclick="fillCaseByEvidence()" class="bg-indigo-600 text-white px-3 py-2 rounded">Find</button>
          </div>

          <label class="text-sm">Evidence ID</label>
          <input id="evidenceID_j" class="w-full border p-2 rounded mb-3" readonly />

          <label class="text-sm">Judgment ğŸ›ï¸</label>
          <textarea id="judgmentText" class="w-full border p-2 rounded mb-3"></textarea>

          <label class="text-sm">Closing Date ğŸ—“ï¸</label>
          <input id="closingDate" type="date" class="w-full border p-2 rounded mb-3" />

          <div class="flex gap-3">
            <button id="btnSubmitJudgment" type="button" onclick="submitJudgment()" class="flex-1 bg-purple-600 text-white py-2 rounded disabled:opacity-60" disabled>Submit Judgment (on-chain)</button>
            <button type="button" onclick="clearJudgmentForm()" class="flex-1 bg-gray-100 py-2 rounded">Clear</button>
          </div>
        </div>
      </section>

      <!-- CASE TRACKING -->
      <section id="trackingTab" class="hidden">
        <h3 class="text-xl font-semibold mb-3">ğŸ” Case Tracking</h3>

        <div class="bg-white rounded shadow p-4 mb-4 max-w-5xl">
          <div class="flex gap-2">
            <input id="searchTracking" placeholder="Search Evidence ID / Aadhaar / Accused" class="flex-1 border p-2 rounded" />
            <button type="button" onclick="searchCase()" class="bg-green-600 text-white px-3 py-2 rounded">Search</button>
            <button type="button" onclick="fetchAllCases()" class="bg-gray-200 px-3 py-2 rounded">Refresh</button>
          </div>
        </div>

        <div class="overflow-auto bg-white rounded shadow max-w-5xl">
          <table id="trackingResultsTable" class="min-w-full table-auto border-collapse hidden">
            <thead class="bg-gray-100">
              <tr>
                <th class="border p-2 text-left">Evidence ID</th>
                <th class="border p-2 text-left">Unique ID</th>
                <th class="border p-2 text-left">Aadhaar</th>
                <th class="border p-2 text-left">Accused</th>
                <th class="border p-2 text-left">Case Detail</th>
                <th class="border p-2 text-left">Location</th>
                <th class="border p-2 text-left">Crime DateTime</th>
                <th class="border p-2 text-left">Registration DateTime</th>
              </tr>
            </thead>
            <tbody id="trackingResults"></tbody>
          </table>
          <div id="noCases" class="p-4 text-center text-gray-500 hidden">No cases found.</div>
        </div>
      </section>

    </main>
  </div>
</div>

<script>
/* -------------------------
   CONFIG â€” REPLACE WITH YOUR CONTRACT DETAILS
   -------------------------
   - Put the exact ABI (JSON) of your deployed contract below
   - Put your contract's deployed address in contractAddress
*/
const contractABI = [
  /* Example ABI placeholders - replace with your contract's ABI */
  {
    "inputs": [
      {"internalType":"string","name":"aadhaar","type":"string"},
      {"internalType":"string","name":"accused","type":"string"},
      {"internalType":"string","name":"caseDetail","type":"string"},
      {"internalType":"string","name":"location","type":"string"},
      {"internalType":"string","name":"crimeDateTime","type":"string"}
    ],
    "name":"registerCase",
    "outputs":[],
    "stateMutability":"nonpayable",
    "type":"function"
  },
  {
    "inputs":[
      {"internalType":"string","name":"evidenceID","type":"string"},
      {"internalType":"string","name":"judgment","type":"string"},
      {"internalType":"string","name":"closingDate","type":"string"}
    ],
    "name":"submitJudgment",
    "outputs":[],
    "stateMutability":"nonpayable",
    "type":"function"
  },
  {
    "inputs":[],
    "name":"getAllCases",
    "outputs":[
      {
        "components":[
          {"internalType":"string","name":"evidenceID","type":"string"},
          {"internalType":"string","name":"uniqueID","type":"string"},
          {"internalType":"string","name":"aadhaar","type":"string"},
          {"internalType":"string","name":"accused","type":"string"},
          {"internalType":"string","name":"caseDetail","type":"string"},
          {"internalType":"string","name":"location","type":"string"},
          {"internalType":"string","name":"crimeDateTime","type":"string"},
          {"internalType":"string","name":"registrationDateTime","type":"string"}
        ],
        "internalType":"struct Evidence.Case[]",
        "name":"",
        "type":"tuple[]"
      }
    ],
    "stateMutability":"view",
    "type":"function"
  },
  {
    "inputs":[ {"internalType":"string","name":"evidenceID","type":"string"} ],
    "name":"getCaseByEvidenceID",
    "outputs":[
      {
        "components":[
          {"internalType":"string","name":"evidenceID","type":"string"},
          {"internalType":"string","name":"uniqueID","type":"string"},
          {"internalType":"string","name":"aadhaar","type":"string"},
          {"internalType":"string","name":"accused","type":"string"},
          {"internalType":"string","name":"caseDetail","type":"string"},
          {"internalType":"string","name":"location","type":"string"},
          {"internalType":"string","name":"crimeDateTime","type":"string"},
          {"internalType":"string","name":"registrationDateTime","type":"string"}
        ],
        "internalType":"struct Evidence.Case",
        "name":"",
        "type":"tuple"
      }
    ],
    "stateMutability":"view",
    "type":"function"
  }
];
const contractAddress = "0xYourContractAddressHere"; // <-- REPLACE

/* -------------------------
   Runtime state
   ------------------------- */
let provider = null;
let signer = null;
let contract = null;
let userAddress = null;
let role = '';

/* -------------------------
   UI Utilities
   ------------------------- */
function setWalletUI(address) {
  const label = address ? truncateAddress(address) : 'Connect Wallet';
  document.getElementById('walletLabel').innerText = label;
  document.getElementById('walletTooltip').innerText = address ? address : 'Not connected';
  document.getElementById('walletFullAddr').innerText = address ? address : 'Not connected';
  document.getElementById('homeWallet').innerText = address ? address : 'Not connected';
  document.getElementById('connectedAddressSidebar').innerText = address ? 'Addr: ' + address : '';
  // enable/disable write buttons
  const able = !!address;
  document.getElementById('btnRegisterCase').disabled = !able;
  document.getElementById('btnSubmitJudgment').disabled = !able;
}

/* Truncate 0xabc...123 */
function truncateAddress(a){
  if(!a) return '';
  return a.slice(0,6) + '...' + a.slice(-4);
}

/* Wallet dropdown toggle */
function toggleWalletDropdown(){
  const dd = document.getElementById('walletDropdown');
  dd.classList.toggle('hidden');
}

/* Connect wallet (top-right or login) */
async function connectWallet(){
  if(!window.ethereum){
    alert('MetaMask not found. Install MetaMask and try again.');
    return;
  }
  try{
    await window.ethereum.request({ method: 'eth_requestAccounts' });
    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    contract = new ethers.Contract(contractAddress, contractABI, signer);

    // UI updates
    setWalletUI(userAddress);
    document.getElementById('connectWalletBtnInitial').style.display = 'none';
    document.getElementById('walletConnectTopBtn').classList.add('ring','ring-gray-200');

    // Optionally detect network (example: check chainId)
    try{
      const network = await provider.getNetwork();
      console.log('Connected network:', network);
    }catch(e){}

    // Show dashboard if login was done or public selected
    showDashboard();
  }catch(err){
    console.error('connectWallet err', err);
    alert('Wallet connection failed: ' + (err.message || err));
  }
}

/* Disconnect wallet (UI only) */
function disconnectWallet(){
  // Clear local state; MetaMask doesn't provide programmatic disconnect for dapps
  provider = null;
  signer = null;
  contract = null;
  userAddress = null;
  setWalletUI(null);
  document.getElementById('walletDropdown').classList.add('hidden');
  document.getElementById('walletConnectTopBtn').classList.remove('ring','ring-gray-200');
}

/* Role selection + login logic */
function selectRole(selectedRole){
  role = selectedRole;
  document.getElementById('loginForm').classList.add('hidden');
  document.getElementById('walletConnectLogin').classList.add('hidden');

  // show role-appropriate UI on login page
  if(role === 'Public'){
    document.getElementById('walletConnectLogin').classList.remove('hidden');
    document.getElementById('registerBtn').style.display = 'none';
    document.getElementById('judgmentBtn').style.display = 'none';
  } else {
    document.getElementById('loginForm').classList.remove('hidden');
    document.getElementById('registerBtn').style.display = role === 'Police' ? 'block' : 'none';
    document.getElementById('judgmentBtn').style.display = role === 'Court' ? 'block' : 'none';
  }
}

function login(){
  const u = document.getElementById('username').value;
  const p = document.getElementById('password').value;
  if(!u || !p){ alert('Enter username and password'); return; }

  // For simplicity we accept any username/password â€” connect wallet now
  connectWallet();
}

/* Show dashboard and initial load */
function showDashboard(){
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('dashboard').style.display = 'flex';
  showTab('dashboardTab');

  // set registration datetime to now
  const now = new Date().toISOString().slice(0,16);
  document.getElementById('registrationDateTime').value = now;

  // fetch cases so public can see data
  fetchAllCases();
}

/* Logout (UI-only) */
function logout(){
  // reset role + UI
  role = '';
  disconnectWallet();
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('loginPage').style.display = 'flex';
  // reset forms
  clearRegisterForm(); clearJudgmentForm();
}

/* Tab behavior */
function showTab(tabId){
  ['dashboardTab','registerTab','judgmentTab','trackingTab'].forEach(id=>{
    document.getElementById(id).classList.add('hidden');
  });
  document.getElementById(tabId).classList.remove('hidden');

  const titleMap = {
    dashboardTab: ['Dashboard','Overview'],
    registerTab: ['Register Case','Police â†’ Register new case'],
    judgmentTab: ['Submit Judgment','Court â†’ Submit judgment'],
    trackingTab: ['Case Tracking','Search and view cases']
  };
  const t = titleMap[tabId] || ['Dashboard',''];
  document.getElementById('pageTitle').innerText = t[0];
  document.getElementById('pageSubtitle').innerText = t[1];

  if(tabId === 'trackingTab') fetchAllCases();
}

/* Clear forms */
function clearRegisterForm(){
  ['aadhaar','accusedName','caseDetail','crimeLocation','crimeDateTime'].forEach(id=>document.getElementById(id).value='');
}
function clearJudgmentForm(){
  ['searchJudgment','evidenceID_j','judgmentText','closingDate'].forEach(id=>document.getElementById(id).value='');
}

/* -------------------------
   Blockchain interactions
   ------------------------- */

/* Normalize returned case object (supports tuple or object) */
function normalizeCase(c){
  return {
    evidenceID: c.evidenceID ?? c[0] ?? '',
    uniqueID:  c.uniqueID  ?? c[1] ?? '',
    aadhaar:   c.aadhaar   ?? c[2] ?? '',
    accused:   c.accused   ?? c[3] ?? '',
    caseDetail:c.caseDetail?? c[4] ?? '',
    location:  c.location  ?? c[5] ?? '',
    crimeDateTime: c.crimeDateTime ?? c[6] ?? '',
    registrationDateTime: c.registrationDateTime ?? c[7] ?? ''
  };
}

/* Register Case (on-chain) */
async function registerCase(){
  if(!contract || !signer || !userAddress){ alert('Connect wallet first'); return; }

  const aadhaar = document.getElementById('aadhaar').value.trim();
  const accused = document.getElementById('accusedName').value.trim();
  const caseDetail = document.getElementById('caseDetail').value.trim();
  const location = document.getElementById('crimeLocation').value.trim();
  const crimeDateTime = document.getElementById('crimeDateTime').value;

  if(!aadhaar || !accused || !caseDetail || !location || !crimeDateTime){
    alert('Please fill all required fields.');
    return;
  }

  try{
    const tx = await contract.registerCase(aadhaar, accused, caseDetail, location, crimeDateTime);
    alert(`Transaction sent: ${tx.hash}`);
    await tx.wait();
    alert('Case registered on-chain.');
    clearRegisterForm();
    fetchAllCases();
  }catch(err){
    console.error(err);
    alert('Error registering case: ' + (err?.message || err));
  }
}

/* Submit Judgment (on-chain) */
async function submitJudgment(){
  if(!contract || !signer || !userAddress){ alert('Connect wallet first'); return; }

  const evidenceID = document.getElementById('evidenceID_j').value.trim();
  const judgment = document.getElementById('judgmentText').value.trim();
  const closingDate = document.getElementById('closingDate').value;

  if(!evidenceID || !judgment || !closingDate){
    alert('Fill evidence ID, judgment text and closing date.');
    return;
  }

  try{
    const tx = await contract.submitJudgment(evidenceID, judgment, closingDate);
    alert(`Transaction sent: ${tx.hash}`);
    await tx.wait();
    alert('Judgment submitted on-chain.');
    clearJudgmentForm();
    fetchAllCases();
  }catch(err){
    console.error(err);
    alert('Error submitting judgment: ' + (err?.message || err));
  }
}

/* Fetch all cases (view) â€” tries to use contract if connected, otherwise attempts read-only provider */
async function fetchAllCases(){
  try{
    let raw;
    if(contract){
      raw = await contract.getAllCases();
    } else if(window.ethereum){
      // Read-only provider using user's provider (no wallet required just provider)
      const readProvider = new ethers.providers.Web3Provider(window.ethereum);
      const readContract = new ethers.Contract(contractAddress, contractABI, readProvider);
      raw = await readContract.getAllCases();
    } else {
      // No provider available
      renderCases([]);
      return;
    }
    renderCases(raw);
  }catch(err){
    console.error('fetchAllCases error', err);
    renderCases([]);
  }
}

/* Search (client-side filter) */
async function searchCase(){
  const q = document.getElementById('searchTracking').value.trim().toLowerCase();
  try{
    let raw;
    if(contract){
      raw = await contract.getAllCases();
    } else if(window.ethereum){
      const readProvider = new ethers.providers.Web3Provider(window.ethereum);
      const readContract = new ethers.Contract(contractAddress, contractABI, readProvider);
      raw = await readContract.getAllCases();
    } else {
      renderCases([]);
      return;
    }

    const parsed = (raw || []).map(normalizeCase);
    if(!q){
      renderCases(parsed);
      return;
    }
    const filtered = parsed.filter(c =>
      (c.evidenceID||'').toLowerCase().includes(q) ||
      (c.aadhaar||'').toLowerCase().includes(q) ||
      (c.accused||'').toLowerCase().includes(q)
    );
    renderCases(filtered);
  }catch(err){
    console.error(err);
    renderCases([]);
  }
}

/* Fill judgment form by evidence id */
async function fillCaseByEvidence(){
  const id = document.getElementById('searchJudgment').value.trim();
  if(!id){ alert('Enter an Evidence ID'); return; }
  try{
    // require contract for single-case read for now
    if(!contract && window.ethereum){
      const readProvider = new ethers.providers.Web3Provider(window.ethereum);
      const readContract = new ethers.Contract(contractAddress, contractABI, readProvider);
      const raw = await readContract.getCaseByEvidenceID(id);
      const c = normalizeCase(raw);
      if(!c || !c.evidenceID){ alert('Case not found'); return; }
      document.getElementById('evidenceID_j').value = c.evidenceID;
      return;
    }
    if(!contract){ alert('Connect wallet to use this feature'); return; }
    const raw = await contract.getCaseByEvidenceID(id);
    const c = normalizeCase(raw);
    if(!c || !c.evidenceID){ alert('Case not found'); return; }
    document.getElementById('evidenceID_j').value = c.evidenceID;
  }catch(err){
    console.error(err);
    alert('Error fetching case: ' + (err?.message || err));
  }
}

/* Render cases into table */
function renderCases(rawArray){
  const rows = (rawArray || []).map(normalizeCase);
  const tbody = document.getElementById('trackingResults');
  tbody.innerHTML = '';
  if(!rows || rows.length === 0){
    document.getElementById('trackingResultsTable').classList.add('hidden');
    document.getElementById('noCases').classList.remove('hidden');
    return;
  }

  rows.forEach(c => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="border p-2 font-mono">${escapeHtml(c.evidenceID)}</td>
      <td class="border p-2 font-mono">${escapeHtml(c.uniqueID)}</td>
      <td class="border p-2">${escapeHtml(c.aadhaar)}</td>
      <td class="border p-2">${escapeHtml(c.accused)}</td>
      <td class="border p-2">${escapeHtml(c.caseDetail)}</td>
      <td class="border p-2">${escapeHtml(c.location)}</td>
      <td class="border p-2">${escapeHtml(c.crimeDateTime)}</td>
      <td class="border p-2">${escapeHtml(c.registrationDateTime)}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('trackingResultsTable').classList.remove('hidden');
  document.getElementById('noCases').classList.add('hidden');
}

/* Simple escaping */
function escapeHtml(s){
  if(s === null || s === undefined) return '';
  return String(s)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#039;');
}

/* Init actions on load */
window.onload = function(){
  // initial UI
  document.getElementById('loginPage').style.display = 'flex';
  document.getElementById('dashboard').style.display = 'none';
  setWalletUI(null); // disables write buttons

  // Hide wallet dropdown when clicking outside
  document.addEventListener('click', function(e){
    const dropdown = document.getElementById('walletDropdown');
    const btn = document.getElementById('walletConnectTopBtn');
    if(!btn.contains(e.target) && !dropdown.contains(e.target)){
      dropdown.classList.add('hidden');
    }
  });
};
</script>
</body>
</html>

