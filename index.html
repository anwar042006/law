<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ” Blockchain Evidence Tracking â€” Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen font-sans">

<!-- LOGIN CARD -->
<div id="loginPage" class="flex items-center justify-center min-h-screen">
  <div class="w-96 bg-white rounded-xl shadow-lg p-6 text-center">
    <h1 class="text-2xl font-bold mb-4">ğŸ” Evidence Tracking</h1>

    <div class="space-y-2 mb-4">
      <button onclick="selectRole('Police')" class="w-full py-2 rounded bg-blue-500 text-white">ğŸ‘® Police</button>
      <button onclick="selectRole('Court')" class="w-full py-2 rounded bg-purple-500 text-white">ğŸ›ï¸ Court</button>
      <button onclick="selectRole('Public')" class="w-full py-2 rounded bg-green-500 text-white">ğŸ‘¥ Public</button>
    </div>

    <div id="loginForm" class="hidden space-y-2">
      <input id="username" placeholder="Username" class="w-full border p-2 rounded" />
      <input id="password" placeholder="Password" type="password" class="w-full border p-2 rounded" />
      <button onclick="login()" class="w-full bg-indigo-600 text-white py-2 rounded">Login & Connect Wallet</button>
    </div>

    <div id="walletConnectLogin" class="hidden space-y-2">
      <button id="connectWalletBtn" onclick="connectWallet()" class="w-full bg-yellow-400 text-black py-2 rounded">Connect Wallet ğŸ¦Š</button>
      <p id="walletAddress" class="text-xs text-gray-500 break-words"></p>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden flex h-screen">
  <!-- SIDEBAR -->
  <aside class="w-64 bg-gray-900 text-white flex flex-col">
    <div class="p-4 font-bold border-b border-gray-700">ğŸ” Dashboard</div>
    <nav class="flex-1">
      <button onclick="showTab('dashboardTab')" class="w-full text-left px-4 py-3 hover:bg-gray-800">ğŸ  Home</button>
      <button id="registerBtn" onclick="showTab('registerTab')" class="w-full text-left px-4 py-3 hover:bg-gray-800">ğŸ“ Register Case</button>
      <button id="judgmentBtn" onclick="showTab('judgmentTab')" class="w-full text-left px-4 py-3 hover:bg-gray-800">ğŸ›ï¸ Submit Judgment</button>
      <button onclick="showTab('trackingTab')" class="w-full text-left px-4 py-3 hover:bg-gray-800">ğŸ” Case Tracking</button>
    </nav>
    <div class="p-4 border-t border-gray-700">
      <div id="connectedAddress" class="text-xs break-words"></div>
      <button onclick="logout()" class="mt-3 w-full bg-gray-700 py-2 rounded">ğŸ”‘ Logout</button>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="flex-1 p-6 overflow-auto">
    <!-- HOME -->
    <section id="dashboardTab">
      <h2 class="text-2xl font-semibold mb-2">Welcome</h2>
      <p class="text-gray-600 mb-4">Use sidebar to register cases, submit judgments or track cases. Wallet required for blockchain write operations.</p>
      <div class="space-y-3">
        <div class="bg-white p-4 rounded shadow">
          <div class="text-sm text-gray-600">Connected Wallet</div>
          <div id="homeWallet" class="font-mono text-sm text-gray-800">Not connected</div>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <div class="text-sm text-gray-600">Notes</div>
          <ul class="list-disc pl-5 text-sm text-gray-700">
            <li>Replace ABI & contract address below with your contract's real ABI & address.</li>
            <li>Contract must expose read/write functions used in this UI (see ABI placeholders).</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- REGISTER CASE -->
    <section id="registerTab" class="hidden">
      <h2 class="text-2xl font-semibold mb-4">ğŸ“ Register Case</h2>
      <div class="bg-white p-6 rounded shadow max-w-2xl">
        <label class="block text-sm">Aadhaar ğŸ†”</label>
        <input id="aadhaar" maxlength="12" class="w-full border p-2 rounded mb-3" />
        <label class="block text-sm">Accused Name ğŸ‘¤</label>
        <input id="accusedName" class="w-full border p-2 rounded mb-3" />
        <label class="block text-sm">Case Detail ğŸ“</label>
        <textarea id="caseDetail" class="w-full border p-2 rounded mb-3"></textarea>
        <label class="block text-sm">Crime Location ğŸ“</label>
        <input id="crimeLocation" class="w-full border p-2 rounded mb-3" />
        <label class="block text-sm">Crime Date & Time ğŸ•’</label>
        <input id="crimeDateTime" type="datetime-local" class="w-full border p-2 rounded mb-3" />
        <label class="block text-sm">Registration Date & Time ğŸ—“ï¸ (auto)</label>
        <input id="registrationDateTime" type="datetime-local" class="w-full border p-2 rounded mb-3" readonly />
        <div class="flex space-x-2">
          <button onclick="registerCase()" class="flex-1 bg-blue-600 text-white py-2 rounded">Register Case (on-chain)</button>
          <button onclick="clearRegisterForm()" class="flex-1 bg-gray-200 py-2 rounded">Clear</button>
        </div>
      </div>
    </section>

    <!-- SUBMIT JUDGMENT -->
    <section id="judgmentTab" class="hidden">
      <h2 class="text-2xl font-semibold mb-4">ğŸ›ï¸ Submit Judgment</h2>
      <div class="bg-white p-6 rounded shadow max-w-2xl">
        <label class="block text-sm">Search Evidence ID (for quick fill)</label>
        <div class="flex gap-2 mb-3">
          <input id="searchJudgment" placeholder="Evidence ID" class="flex-1 border p-2 rounded" />
          <button onclick="fillCaseByEvidence()" class="bg-indigo-600 text-white py-2 px-3 rounded">Find</button>
        </div>

        <label class="block text-sm">Evidence ID</label>
        <input id="evidenceID_j" class="w-full border p-2 rounded mb-3" readonly />

        <label class="block text-sm">Judgment ğŸ›ï¸</label>
        <textarea id="judgmentText" class="w-full border p-2 rounded mb-3"></textarea>

        <label class="block text-sm">Closing Date ğŸ—“ï¸</label>
        <input id="closingDate" type="date" class="w-full border p-2 rounded mb-3" />

        <div class="flex gap-2">
          <button onclick="submitJudgment()" class="flex-1 bg-purple-600 text-white py-2 rounded">Submit Judgment (on-chain)</button>
          <button onclick="clearJudgmentForm()" class="flex-1 bg-gray-200 py-2 rounded">Clear</button>
        </div>
      </div>
    </section>

    <!-- CASE TRACKING -->
    <section id="trackingTab" class="hidden">
      <h2 class="text-2xl font-semibold mb-4">ğŸ” Case Tracking</h2>

      <div class="bg-white p-4 rounded shadow max-w-4xl mb-4">
        <div class="flex gap-2">
          <input id="searchTracking" placeholder="Search Evidence ID / Aadhaar / Accused" class="flex-1 border p-2 rounded" />
          <button onclick="searchCase()" class="bg-green-600 text-white py-2 px-3 rounded">Search</button>
          <button onclick="fetchAllCases()" class="bg-gray-300 py-2 px-3 rounded">Refresh</button>
        </div>
      </div>

      <div class="overflow-auto bg-white rounded shadow">
        <table id="trackingResultsTable" class="min-w-full table-auto border-collapse hidden">
          <thead class="bg-gray-100">
            <tr>
              <th class="border p-2 text-left">Evidence ID</th>
              <th class="border p-2 text-left">Unique ID</th>
              <th class="border p-2 text-left">Aadhaar</th>
              <th class="border p-2 text-left">Accused</th>
              <th class="border p-2 text-left">Case Detail</th>
              <th class="border p-2 text-left">Location</th>
              <th class="border p-2 text-left">Crime DateTime</th>
              <th class="border p-2 text-left">Registration DateTime</th>
            </tr>
          </thead>
          <tbody id="trackingResults"></tbody>
        </table>
        <div id="noCases" class="p-4 text-center text-gray-500 hidden">No cases found</div>
      </div>
    </section>
  </main>
</div>

<script>
/* ---------------------------
   CONFIG: Replace these!
   ---------------------------
   - Put your real contract ABI (exact JSON) in contractABI
   - Put your deployed contract address in contractAddress
*/
const contractABI = [
  
  },
  {
    "inputs":[],
    "name":"getAllCases",
    "outputs":[ [
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "uniqueID",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "aadhaar",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "accused",
				"type": "string"
			}
		],
		"name": "CaseRegistered",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "judgment",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "closingDate",
				"type": "string"
			}
		],
		"name": "JudgmentSubmitted",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "caseCounter",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "evidenceCounter",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getAllCases",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "uniqueID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "aadhaar",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "accused",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "caseDetail",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "location",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "crimeDateTime",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "registrationDateTime",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "judgment",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "closingDate",
						"type": "string"
					}
				],
				"internalType": "struct Evidence.Case[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			}
		],
		"name": "getCaseByEvidenceID",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "uniqueID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "aadhaar",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "accused",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "caseDetail",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "location",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "crimeDateTime",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "registrationDateTime",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "judgment",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "closingDate",
						"type": "string"
					}
				],
				"internalType": "struct Evidence.Case",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "aadhaar",
				"type": "string"
			}
		],
		"name": "getCaseCountByAadhaar",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "aadhaar",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "accused",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "caseDetail",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "location",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "crimeDateTime",
				"type": "string"
			}
		],
		"name": "registerCase",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "judgment",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "closingDate",
				"type": "string"
			}
		],
		"name": "submitJudgment",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	}
]       
];
const contractAddress = "0xB8bbfC476Ce4BCc208aecB5Ac235581dd304fC02"; // <-- replace with your deployed contract address

/* ---------------------------
   Runtime state
   --------------------------- */
let provider, signer, contract, userAddress;
let role = '';

/* ---------------------------
   UI helpers
   --------------------------- */
function selectRole(selectedRole){
  role = selectedRole;
  document.getElementById('loginForm').classList.add('hidden');
  document.getElementById('walletConnectLogin').classList.add('hidden');

  if(role === 'Public'){
    document.getElementById('walletConnectLogin').classList.remove('hidden');
    document.getElementById('registerBtn').style.display = 'none';
    document.getElementById('judgmentBtn').style.display = 'none';
  } else {
    document.getElementById('loginForm').classList.remove('hidden');
    document.getElementById('registerBtn').style.display = role === 'Police' ? 'block' : 'none';
    document.getElementById('judgmentBtn').style.display = role === 'Court' ? 'block' : 'none';
  }
}

async function connectWallet(){
  if(!window.ethereum){ alert('MetaMask not found â€” install it first'); return; }
  try{
    await window.ethereum.request({ method: 'eth_requestAccounts' });
    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    contract = new ethers.Contract(contractAddress, contractABI, signer);

    // UI updates
    document.getElementById('walletAddress').innerText = `Connected: ${userAddress}`;
    document.getElementById('connectedAddress').innerText = `Addr: ${userAddress}`;
    document.getElementById('homeWallet').innerText = userAddress;
    document.getElementById('connectWalletBtn').style.display = 'none';

    // Show dashboard
    showDashboard();
  } catch (err) {
    console.error(err);
    alert('Wallet connection cancelled or failed: ' + (err.message || err));
  }
}

function login(){
  // dummy validation â€” just require non-empty username/password
  const u = document.getElementById('username').value;
  const p = document.getElementById('password').value;
  if(!u || !p){ alert('Enter username and password'); return; }
  connectWallet();
}

function logout(){
  role = '';
  userAddress = null;
  contract = null;
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('loginPage').style.display = 'flex';
  document.getElementById('walletAddress').innerText = '';
  document.getElementById('homeWallet').innerText = 'Not connected';
  document.getElementById('connectedAddress').innerText = '';
  document.getElementById('connectWalletBtn').style.display = 'inline-block';
}

/* Tabs */
function showTab(tabId){
  ['dashboardTab','registerTab','judgmentTab','trackingTab'].forEach(id=>{
    document.getElementById(id).classList.add('hidden');
  });
  document.getElementById(tabId).classList.remove('hidden');

  // If tracking tab opened, ensure latest data
  if(tabId === 'trackingTab'){
    fetchAllCases();
  }
}

/* Dashboard show */
function showDashboard(){
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('dashboard').style.display = 'flex';
  showTab('dashboardTab');

  const now = new Date().toISOString().slice(0,16);
  document.getElementById('registrationDateTime').value = now;
  fetchAllCases();
}

/* Clear forms */
function clearRegisterForm(){
  ['aadhaar','accusedName','caseDetail','crimeLocation','crimeDateTime'].forEach(id => document.getElementById(id).value = '');
}
function clearJudgmentForm(){
  ['searchJudgment','evidenceID_j','judgmentText','closingDate'].forEach(id=> document.getElementById(id).value = '');
}

/* ---------------------------
   Blockchain interactions
   --------------------------- */

function normalizeCase(c){
  // Accept either object with named fields or tuple-style arrays.
  return {
    evidenceID: c.evidenceID ?? c[0] ?? '',
    uniqueID:  c.uniqueID  ?? c[1] ?? '',
    aadhaar:   c.aadhaar   ?? c[2] ?? '',
    accused:   c.accused   ?? c[3] ?? '',
    caseDetail:c.caseDetail?? c[4] ?? '',
    location:  c.location  ?? c[5] ?? '',
    crimeDateTime: c.crimeDateTime ?? c[6] ?? '',
    registrationDateTime: c.registrationDateTime ?? c[7] ?? ''
  };
}

// Register case on-chain
async function registerCase(){
  if(!userAddress){ alert('Connect wallet first'); return; }
  const aadhaar = document.getElementById('aadhaar').value.trim();
  const accused = document.getElementById('accusedName').value.trim();
  const caseDetail = document.getElementById('caseDetail').value.trim();
  const location = document.getElementById('crimeLocation').value.trim();
  const crimeDateTime = document.getElementById('crimeDateTime').value;

  if(!aadhaar || !accused || !caseDetail || !location || !crimeDateTime){
    alert('Please fill all fields');
    return;
  }

  try{
    // Call contract registerCase(aadhaar, accused, caseDetail, location, crimeDateTime)
    const tx = await contract.registerCase(aadhaar, accused, caseDetail, location, crimeDateTime);
    showTxPending(tx.hash);
    await tx.wait();
    alert('Case registered on-chain successfully.');
    clearRegisterForm();
    fetchAllCases();
  }catch(err){
    console.error(err);
    alert('Register error: ' + (err.data?.message || err.message || err));
  }
}

// Submit judgment on-chain
async function submitJudgment(){
  if(!userAddress){ alert('Connect wallet first'); return; }
  const evidenceID = document.getElementById('evidenceID_j').value.trim();
  const judgment = document.getElementById('judgmentText').value.trim();
  const closingDate = document.getElementById('closingDate').value;

  if(!evidenceID || !judgment || !closingDate){
    alert('Fill evidence id, judgment and closing date');
    return;
  }

  try{
    const tx = await contract.submitJudgment(evidenceID, judgment, closingDate);
    showTxPending(tx.hash);
    await tx.wait();
    alert('Judgment submitted on-chain successfully.');
    clearJudgmentForm();
    fetchAllCases();
  }catch(err){
    console.error(err);
    alert('Submit judgment error: ' + (err.data?.message || err.message || err));
  }
}

/* Fetch all cases (view) */
async function fetchAllCases(){
  if(!contract){ 
    // If public role and no wallet connected, we can attempt a read-only provider
    if(window.ethereum){
      const readProvider = new ethers.providers.Web3Provider(window.ethereum);
      const readContract = new ethers.Contract(contractAddress, contractABI, readProvider);
      try{
        const raw = await readContract.getAllCases();
        renderCases(raw);
      }catch(err){
        console.warn('Read-only fetch failed (ethereum present):', err);
        showNoCases();
      }
    } else {
      showNoCases();
    }
    return;
  }

  try{
    const raw = await contract.getAllCases();
    renderCases(raw);
  }catch(err){
    console.error('fetchAllCases error', err);
    showNoCases();
  }
}

/* Search in local fetched list (or query getCaseByEvidenceID if you want exact fetch) */
async function searchCase(){
  const q = document.getElementById('searchTracking').value.trim().toLowerCase();
  if(!q){
    fetchAllCases();
    return;
  }

  try{
    // Get all cases and filter client-side for convenience
    const raw = contract ? await contract.getAllCases() : await (new ethers.providers.Web3Provider(window.ethereum)).call({
      to: contractAddress
    }).catch(()=>[]);
    const parsed = (raw || []).map(normalizeCase);
    const results = parsed.filter(c =>
      (c.evidenceID || '').toLowerCase().includes(q) ||
      (c.aadhaar || '').toLowerCase().includes(q) ||
      (c.accused || '').toLowerCase().includes(q)
    );
    renderCases(results);
  }catch(err){
    console.error(err);
    showNoCases();
  }
}

/* Fill judgment form by evidence id (reads single case) */
async function fillCaseByEvidence(){
  const id = document.getElementById('searchJudgment').value.trim();
  if(!id){ alert('Enter Evidence ID to find'); return; }
  try{
    // Try calling getCaseByEvidenceID if available
    if(!contract){
      alert('Connect wallet to use this feature');
      return;
    }
    const raw = await contract.getCaseByEvidenceID(id);
    const c = normalizeCase(raw);
    if(!c || !c.evidenceID){ alert('Case not found'); return; }
    document.getElementById('evidenceID_j').value = c.evidenceID;
    // Note: you can also display other read-only fields as needed
  }catch(err){
    console.error(err);
    alert('Error fetching case: ' + (err.message || err));
  }
}

/* Render table rows */
function renderCases(rawArray){
  const rows = rawArray.map(normalizeCase);
  const tbody = document.getElementById('trackingResults');
  tbody.innerHTML = '';

  if(!rows || rows.length === 0){
    showNoCases();
    return;
  }

  rows.forEach(c => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="border p-2 font-mono">${escapeHtml(c.evidenceID)}</td>
      <td class="border p-2 font-mono">${escapeHtml(c.uniqueID)}</td>
      <td class="border p-2">${escapeHtml(c.aadhaar)}</td>
      <td class="border p-2">${escapeHtml(c.accused)}</td>
      <td class="border p-2">${escapeHtml(c.caseDetail)}</td>
      <td class="border p-2">${escapeHtml(c.location)}</td>
      <td class="border p-2">${escapeHtml(c.crimeDateTime)}</td>
      <td class="border p-2">${escapeHtml(c.registrationDateTime)}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('trackingResultsTable').classList.remove('hidden');
  document.getElementById('noCases').classList.add('hidden');
}

/* Helpers to show/hide no cases */
function showNoCases(){
  document.getElementById('trackingResultsTable').classList.add('hidden');
  document.getElementById('noCases').classList.remove('hidden');
}

/* Small helper UI feedback for tx pending */
function showTxPending(hash){
  const w = window;
  const msg = `Transaction submitted: ${hash}\nView on block explorer (network specific).`;
  console.log(msg);
  // non-blocking toast alternative could be added; we just alert here
  alert(msg);
}

/* Basic HTML escaping */
function escapeHtml(s){
  if(!s && s !== 0) return '';
  return String(s)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#039;');
}

/* Initialize small UI behavior: show login screen ready */
(function init(){
  document.getElementById('loginPage').style.display = 'flex';
})();
</script>

</body>
</html>
