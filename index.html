<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Evidence Tracking — Tabbed Sidebar Dashboard (Wallet Top-Right)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
  .wallet-btn { min-width: 170px; }
  .tooltip { position: relative; display: inline-block; }
  .tooltip .tooltiptext {
    visibility: hidden;
    width: max-content;
    background-color: #111827;
    color: #fff;
    text-align: center;
    padding: 6px 8px;
    border-radius: 6px;
    position: absolute;
    z-index: 50;
    top: 140%;
    right: 0;
    white-space: nowrap;
    font-size: 12px;
  }
  .tooltip:hover .tooltiptext { visibility: visible; }
</style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 font-sans text-gray-900">

<!-- LOGIN PAGE -->
<div id="loginPage" class="flex items-center justify-center min-h-screen p-4">
  <div class="w-full max-w-md bg-white rounded-2xl shadow-lg p-6">
    <div class="text-center mb-4">
      <h1 class="text-2xl font-bold">🔐 Evidence Tracking</h1>
      <p class="text-sm text-gray-500 mt-1">Select your role to continue</p>
    </div>

    <div class="grid gap-3 mb-4">
      <button type="button" onclick="selectRole('Police')" class="w-full py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">👮 Police</button>
      <button type="button" onclick="selectRole('Court')" class="w-full py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700">🏛️ Court</button>
      <button type="button" onclick="selectRole('Public')" class="w-full py-2 rounded-lg bg-green-600 text-white hover:bg-green-700">👥 Public</button>
    </div>

    <div id="loginForm" class="hidden space-y-3">
      <input id="username" placeholder="Username" class="w-full border p-2 rounded" />
      <input id="password" placeholder="Password" type="password" class="w-full border p-2 rounded" />
      <button id="loginBtn" type="button" onclick="login()" class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">Login & Connect Wallet</button>
    </div>

    <div id="walletConnectLogin" class="hidden space-y-3">
      <button id="connectWalletBtnInitial" type="button" onclick="connectWallet()" class="w-full bg-yellow-400 text-black py-2 rounded hover:brightness-95">Connect Wallet 🦊</button>
      <button id="publicProceedBtn" type="button" onclick="showDashboardPublic()" class="w-full bg-gray-100 text-black py-2 rounded">Proceed as Public (Read-only)</button>
      <p id="walletAddressInitial" class="text-xs text-gray-500 break-words"></p>
      <p class="text-xs text-gray-400 mt-2">Note: Public users can view cases (read-only). For on-chain writes, connect MetaMask.</p>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden flex h-screen">

  <!-- SIDEBAR -->
  <aside class="w-72 bg-gray-900 text-white flex flex-col">
    <div class="px-6 py-4 border-b border-gray-800 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="text-xl font-bold">📁 Evidence Dashboard</div>
      </div>
    </div>

    <nav class="flex-1 px-2 py-4 space-y-1">
      <button type="button" onclick="showTab('dashboardTab')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-800">🏠 Home</button>
      <button id="registerBtn" type="button" onclick="showTab('registerTab')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-800">📝 Register Case</button>
      <button id="judgmentBtn" type="button" onclick="showTab('judgmentTab')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-800">🏛️ Submit Judgment</button>
      <button type="button" onclick="showTab('trackingTab')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-800">🔍 Case Tracking</button>
    </nav>

    <div class="p-4 border-t border-gray-800">
      <div id="connectedAddressSidebar" class="text-xs text-gray-300 break-words mb-2"></div>
      <button id="logoutBtn" type="button" onclick="logout()" class="w-full bg-gray-700 py-2 rounded hover:bg-gray-600">🔑 Logout</button>
    </div>
  </aside>

  <!-- MAIN AREA -->
  <div class="flex-1 flex flex-col">

    <!-- TOP BAR -->
    <header class="flex items-center justify-between px-6 py-3 bg-white border-b border-gray-200">
      <div>
        <h2 id="pageTitle" class="text-lg font-semibold">Dashboard</h2>
        <p id="pageSubtitle" class="text-xs text-gray-500">Sidebar → Select a tab</p>
      </div>

      <div class="flex items-center gap-3">
        <div id="walletArea" class="tooltip relative">
          <button id="walletConnectTopBtn" type="button" class="wallet-btn inline-flex items-center gap-2 border border-gray-300 rounded px-3 py-2 text-sm bg-white hover:bg-gray-50" onclick="toggleWalletDropdown()">
            <span id="walletIcon" class="text-base">🦊</span>
            <span id="walletLabel" class="font-mono text-sm">Connect Wallet</span>
            <svg id="chev" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
          </button>

          <div class="tooltiptext" id="walletTooltip">Not connected</div>
        </div>

        <div id="walletDropdown" class="hidden absolute right-6 top-14 bg-white border rounded shadow-lg w-56 z-50">
          <div class="p-3 text-sm text-gray-700" id="walletFullAddr">Not connected</div>
          <div class="border-t"></div>
          <button type="button" id="disconnectBtn" onclick="disconnectWallet()" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100">Disconnect</button>
        </div>
      </div>
    </header>

    <!-- CONTENT -->
    <main class="p-6 overflow-auto">

      <!-- HOME -->
      <section id="dashboardTab">
        <div class="grid gap-4">
          <div class="bg-white rounded shadow p-4">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="font-semibold">Welcome</h3>
                <p class="text-sm text-gray-500 mt-1">Use the sidebar to navigate. Connect a wallet (top-right) to perform on-chain actions.</p>
              </div>
              <div class="text-sm text-gray-600 font-mono" id="homeWallet">Not connected</div>
            </div>
          </div>
        </div>
      </section>

      <!-- REGISTER CASE -->
      <section id="registerTab" class="hidden">
        <h3 class="text-xl font-semibold mb-3">📝 Register Case</h3>
        <div class="bg-white rounded shadow p-6 max-w-3xl">
          <div class="grid grid-cols-1 gap-3">
            <label class="text-sm">Aadhaar 🆔</label>
            <input id="aadhaar" maxlength="12" class="w-full border p-2 rounded" />

            <label class="text-sm">Accused Name 👤</label>
            <input id="accusedName" class="w-full border p-2 rounded" />

            <label class="text-sm">Case Detail 📝</label>
            <textarea id="caseDetail" class="w-full border p-2 rounded"></textarea>

            <label class="text-sm">Crime Location 📍</label>
            <input id="crimeLocation" class="w-full border p-2 rounded" />

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm">Crime Date & Time 🕒</label>
                <input id="crimeDateTime" type="datetime-local" class="w-full border p-2 rounded" />
              </div>
              <div>
                <label class="text-sm">Registration Date & Time 🗓️</label>
                <input id="registrationDateTime" type="datetime-local" class="w-full border p-2 rounded" readonly />
              </div>
            </div>

            <!-- Auto-generated visible IDs -->
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm">Evidence ID 💼</label>
                <input id="evidenceID" class="w-full border p-2 rounded font-mono" readonly />
              </div>
              <div>
                <label class="text-sm">Unique ID 🔑</label>
                <input id="uniqueID" class="w-full border p-2 rounded font-mono" readonly />
              </div>
            </div>

            <div class="flex gap-3 mt-2">
              <button id="btnRegisterCase" type="button" onclick="registerCase()" class="flex-1 bg-blue-600 text-white py-2 rounded disabled:opacity-60" disabled>Register Case (on-chain)</button>
              <button type="button" onclick="clearRegisterForm()" class="flex-1 bg-gray-100 py-2 rounded">Clear</button>
            </div>
          </div>
        </div>
      </section>

      <!-- SUBMIT JUDGMENT -->
      <section id="judgmentTab" class="hidden">
        <h3 class="text-xl font-semibold mb-3">🏛️ Submit Judgment</h3>
        <div class="bg-white rounded shadow p-6 max-w-3xl">
          <label class="text-sm">Search Evidence / Accused / Aadhaar</label>
          <div class="flex gap-2 mb-3">
            <input id="searchJudgment" placeholder="Type evidence ID, accused name, or aadhaar" class="flex-1 border p-2 rounded" oninput="filterCourtList()" list="casesList"/>
            <button id="btnFindCase" type="button" onclick="applySelectedCase()" class="bg-indigo-600 text-white px-3 py-2 rounded">Apply</button>
          </div>

          <!-- datalist for browser auto-complete -->
          <datalist id="casesList"></datalist>

          <!-- select for auto-picker -->
          <label class="text-sm">Select matching case (auto picker)</label>
          <select id="casesSelect" class="w-full border p-2 rounded mb-3" onchange="onCourtSelectionChange()">
            <option value="">-- select a case --</option>
          </select>

          <label class="text-sm">Evidence ID</label>
          <input id="evidenceID_j" class="w-full border p-2 rounded mb-3" readonly />

          <label class="text-sm">Judgment 🏛️</label>
          <textarea id="judgmentText" class="w-full border p-2 rounded mb-3"></textarea>

          <label class="text-sm">Closing Date 🗓️</label>
          <input id="closingDate" type="date" class="w-full border p-2 rounded mb-3" />

          <div class="flex gap-3">
            <button id="btnSubmitJudgment" type="button" onclick="submitJudgment()" class="flex-1 bg-purple-600 text-white py-2 rounded disabled:opacity-60" disabled>Submit Judgment (on-chain)</button>
            <button type="button" onclick="clearJudgmentForm()" class="flex-1 bg-gray-100 py-2 rounded">Clear</button>
          </div>
        </div>
      </section>

      <!-- CASE TRACKING -->
      <section id="trackingTab" class="hidden">
        <h3 class="text-xl font-semibold mb-3">🔍 Case Tracking</h3>

        <div class="bg-white rounded shadow p-4 mb-4 max-w-5xl">
          <div class="flex gap-2">
            <input id="searchTracking" placeholder="Search Evidence ID / Aadhaar / Accused" class="flex-1 border p-2 rounded" />
            <button type="button" onclick="searchCase()" class="bg-green-600 text-white px-3 py-2 rounded">Search</button>
            <button type="button" onclick="fetchAllCases()" class="bg-gray-200 px-3 py-2 rounded">Refresh</button>
          </div>
        </div>

        <div class="overflow-auto bg-white rounded shadow max-w-5xl">
          <table id="trackingResultsTable" class="min-w-full table-auto border-collapse hidden">
            <thead class="bg-gray-100">
              <tr>
                <th class="border p-2 text-left">Evidence ID</th>
                <th class="border p-2 text-left">Unique ID</th>
                <th class="border p-2 text-left">Aadhaar</th>
                <th class="border p-2 text-left">Accused</th>
                <th class="border p-2 text-left">Case Detail</th>
                <th class="border p-2 text-left">Location</th>
                <th class="border p-2 text-left">Crime DateTime</th>
                <th class="border p-2 text-left">Registration DateTime</th>
              </tr>
            </thead>
            <tbody id="trackingResults"></tbody>
          </table>
          <div id="noCases" class="p-4 text-center text-gray-500 hidden">No cases found.</div>
        </div>
      </section>

    </main>
  </div>
</div>

<script>
/* -------------------------
   CONFIG — REPLACE WITH YOUR CONTRACT DETAILS
   ------------------------- */
const contractABI = [ [
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "aadhaar",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "accused",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "caseDetail",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "location",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "crimeDateTime",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "registrationDateTime",
				"type": "string"
			}
		],
		"name": "registerCase",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "judgment",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "closingDate",
				"type": "string"
			}
		],
		"name": "submitJudgment",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "cases",
		"outputs": [
			{
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "uniqueID",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "aadhaar",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "accused",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "caseDetail",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "location",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "crimeDateTime",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "registrationDateTime",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "judgment",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "closingDate",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getAllCases",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "uniqueID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "aadhaar",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "accused",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "caseDetail",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "location",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "crimeDateTime",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "registrationDateTime",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "judgment",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "closingDate",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.Case[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			}
		],
		"name": "getCaseByEvidenceID",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "uniqueID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "aadhaar",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "accused",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "caseDetail",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "location",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "crimeDateTime",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "registrationDateTime",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "judgment",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "closingDate",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.Case",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
]
];
const contractAddress = "0x0985acE981cf4BC4387459a0F2d0f0710E54b48F"; // <-- REPLACE

/* -------------------------
   Runtime state
   ------------------------- */
let provider = null;
let signer = null;
let contract = null;
let userAddress = null;
let role = '';
/* local counters fallback (persisted) */
const LOCAL_EVIDENCE_KEY = 'local_ev_counter_v1';
const LOCAL_UNIQUE_KEY = 'local_ui_counter_v1';

/* -------------------------
   UI Utilities
   ------------------------- */
function setWalletUI(address) {
  const label = address ? truncateAddress(address) : 'Connect Wallet';
  document.getElementById('walletLabel').innerText = label;
  document.getElementById('walletTooltip').innerText = address ? address : 'Not connected';
  document.getElementById('walletFullAddr').innerText = address ? address : 'Not connected';
  document.getElementById('homeWallet').innerText = address ? address : 'Not connected';
  document.getElementById('connectedAddressSidebar').innerText = address ? 'Addr: ' + address : '';
  const able = !!address;
  document.getElementById('btnRegisterCase').disabled = !able;
  document.getElementById('btnSubmitJudgment').disabled = !able;
}
function truncateAddress(a){ if(!a) return ''; return a.slice(0,6) + '...' + a.slice(-4); }
function toggleWalletDropdown(){ const dd = document.getElementById('walletDropdown'); dd.classList.toggle('hidden'); }

/* -------------------------
   Wallet connect / disconnect
   ------------------------- */
async function connectWallet(){
  if(!window.ethereum){ alert('MetaMask not found. Install MetaMask and try again.'); return; }
  try{
    await window.ethereum.request({ method: 'eth_requestAccounts' });
    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    contract = new ethers.Contract(contractAddress, contractABI, signer);
    setWalletUI(userAddress);
    document.getElementById('connectWalletBtnInitial').style.display = 'none';
    document.getElementById('walletConnectTopBtn').classList.add('ring','ring-gray-200');
    showDashboard();
  }catch(err){
    console.error('connectWallet err', err);
    alert('Wallet connection failed: ' + (err.message || err));
  }
}
function disconnectWallet(){
  provider = null; signer = null; contract = null; userAddress = null;
  setWalletUI(null);
  document.getElementById('walletDropdown').classList.add('hidden');
  document.getElementById('walletConnectTopBtn').classList.remove('ring','ring-gray-200');
}

/* -------------------------
   Role selection / login
   ------------------------- */
function selectRole(selectedRole){
  role = selectedRole;
  document.getElementById('loginForm').classList.add('hidden');
  document.getElementById('walletConnectLogin').classList.add('hidden');

  if(role === 'Public'){
    // public: show proceed (no wallet required)
    document.getElementById('walletConnectLogin').classList.remove('hidden');
    document.getElementById('registerBtn').style.display = 'none';
    document.getElementById('judgmentBtn').style.display = 'none';
  } else {
    document.getElementById('loginForm').classList.remove('hidden');
    document.getElementById('registerBtn').style.display = role === 'Police' ? 'block' : 'none';
    document.getElementById('judgmentBtn').style.display = role === 'Court' ? 'block' : 'none';
  }
}
function login(){
  const u = document.getElementById('username').value;
  const p = document.getElementById('password').value;
  if(!u || !p){ alert('Enter username and password'); return; }
  connectWallet();
}

/* Public proceed */
function showDashboardPublic(){
  role = 'Public';
  showDashboard();
}

/* Show dashboard and initial load */
function showDashboard(){
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('dashboard').style.display = 'flex';
  showTab('dashboardTab');
  const now = new Date().toISOString().slice(0,16);
  document.getElementById('registrationDateTime').value = now;
  fetchAllCases().then(()=> {
    // populate register IDs if police tab is shown later
    // nothing else
  });
}

/* Logout */
function logout(){
  role = '';
  disconnectWallet();
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('loginPage').style.display = 'flex';
  clearRegisterForm(); clearJudgmentForm();
}

/* Tabs */
function showTab(tabId){
  ['dashboardTab','registerTab','judgmentTab','trackingTab'].forEach(id=>{
    document.getElementById(id).classList.add('hidden');
  });
  document.getElementById(tabId).classList.remove('hidden');

  const titleMap = {
    dashboardTab: ['Dashboard','Overview'],
    registerTab: ['Register Case','Police → Register new case'],
    judgmentTab: ['Submit Judgment','Court → Submit judgment'],
    trackingTab: ['Case Tracking','Search and view cases']
  };
  const t = titleMap[tabId] || ['Dashboard',''];
  document.getElementById('pageTitle').innerText = t[0];
  document.getElementById('pageSubtitle').innerText = t[1];

  // When register tab opened, generate next IDs (using on-chain if available)
  if(tabId === 'registerTab'){
    generateNextIDs().catch(e=>console.warn(e));
  }
  if(tabId === 'trackingTab'){
    fetchAllCases();
  }
  if(tabId === 'judgmentTab'){
    populateCourtLists();
  }
}

/* Clear forms */
function clearRegisterForm(){ ['aadhaar','accusedName','caseDetail','crimeLocation','crimeDateTime'].forEach(id=>document.getElementById(id).value=''); }
function clearJudgmentForm(){ ['searchJudgment','evidenceID_j','judgmentText','closingDate'].forEach(id=>document.getElementById(id).value=''); }

/* -------------------------
   Helpers: parsing & local counters
   ------------------------- */
function normalizeCase(c){
  return {
    evidenceID: c.evidenceID ?? c[0] ?? '',
    uniqueID:  c.uniqueID  ?? c[1] ?? '',
    aadhaar:   c.aadhaar   ?? c[2] ?? '',
    accused:   c.accused   ?? c[3] ?? '',
    caseDetail:c.caseDetail?? c[4] ?? '',
    location:  c.location  ?? c[5] ?? '',
    crimeDateTime: c.crimeDateTime ?? c[6] ?? '',
    registrationDateTime: c.registrationDateTime ?? c[7] ?? ''
  };
}
function parseCounterFromID(idStr, prefix){
  if(!idStr || typeof idStr !== 'string') return 0;
  if(!idStr.startsWith(prefix)) return 0;
  const num = parseInt(idStr.slice(prefix.length), 10);
  return isNaN(num) ? 0 : num;
}
function getLocalCounter(key, start=1){
  const v = localStorage.getItem(key);
  return v ? parseInt(v,10) : start;
}
function setLocalCounter(key, val){
  localStorage.setItem(key, String(val));
}

/* -------------------------
   ID generation logic
   - Attempt to derive next IDs from on-chain cases
   - Fallback to localStorage counters
   ------------------------- */
async function generateNextIDs(){
  try{
    const all = await fetchAllCases(); // returns parsed array
    // compute max EV and UI numbers
    let maxEV = 0, maxUI = 0;
    all.forEach(c=>{
      maxEV = Math.max(maxEV, parseCounterFromID(c.evidenceID,'EV'));
      maxUI = Math.max(maxUI, parseCounterFromID(c.uniqueID,'UI'));
    });
    // compare with local counters
    const localEv = getLocalCounter(LOCAL_EVIDENCE_KEY, 0);
    const localUi = getLocalCounter(LOCAL_UNIQUE_KEY, 0);
    if(localEv > maxEV) maxEV = localEv;
    if(localUi > maxUI) maxUI = localUi;
    const nextEv = maxEV + 1;
    const nextUi = maxUI + 1;
    // persist fallback counters
    setLocalCounter(LOCAL_EVIDENCE_KEY, nextEv);
    setLocalCounter(LOCAL_UNIQUE_KEY, nextUi);
    // set inputs
    document.getElementById('evidenceID').value = 'EV' + String(nextEv).padStart(5,'0');
    document.getElementById('uniqueID').value = 'UI' + String(nextUi).padStart(5,'0');
    return { nextEv, nextUi };
  }catch(err){
    // fallback-only: use local counters
    const localEv = getLocalCounter(LOCAL_EVIDENCE_KEY,1);
    const localUi = getLocalCounter(LOCAL_UNIQUE_KEY,1);
    document.getElementById('evidenceID').value = 'EV' + String(localEv).padStart(5,'0');
    document.getElementById('uniqueID').value = 'UI' + String(localUi).padStart(5,'0');
    return { nextEv: localEv, nextUi: localUi };
  }
}

/* Increment local counters after a successful register (called after tx confirmed) */
function incrementLocalCounters(){
  const currEv = getLocalCounter(LOCAL_EVIDENCE_KEY,1);
  const currUi = getLocalCounter(LOCAL_UNIQUE_KEY,1);
  setLocalCounter(LOCAL_EVIDENCE_KEY, currEv + 1);
  setLocalCounter(LOCAL_UNIQUE_KEY, currUi + 1);
}

/* -------------------------
   Blockchain interactions
   ------------------------- */

/* Register Case (on-chain) */
async function registerCase(){
  if(!contract || !signer || !userAddress){ alert('Connect wallet first'); return; }

  const aadhaar = document.getElementById('aadhaar').value.trim();
  const accused = document.getElementById('accusedName').value.trim();
  const caseDetail = document.getElementById('caseDetail').value.trim();
  const location = document.getElementById('crimeLocation').value.trim();
  const crimeDateTime = document.getElementById('crimeDateTime').value;

  if(!aadhaar || !accused || !caseDetail || !location || !crimeDateTime){
    alert('Please fill all required fields.');
    return;
  }

  try{
    const tx = await contract.registerCase(aadhaar, accused, caseDetail, location, crimeDateTime);
    alert(`Transaction sent: ${tx.hash}`);
    await tx.wait();
    alert('Case registered on-chain.');
    // bump local counters
    incrementLocalCounters();
    clearRegisterForm();
    // refresh cases + re-generate next ids
    await fetchAllCases();
    await generateNextIDs();
  }catch(err){
    console.error(err);
    alert('Error registering case: ' + (err?.message || err));
  }
}

/* Submit Judgment (on-chain) */
async function submitJudgment(){
  if(!contract || !signer || !userAddress){ alert('Connect wallet first'); return; }

  const evidenceID = document.getElementById('evidenceID_j').value.trim();
  const judgment = document.getElementById('judgmentText').value.trim();
  const closingDate = document.getElementById('closingDate').value;

  if(!evidenceID || !judgment || !closingDate){
    alert('Fill evidence ID, judgment text and closing date.');
    return;
  }

  try{
    const tx = await contract.submitJudgment(evidenceID, judgment, closingDate);
    alert(`Transaction sent: ${tx.hash}`);
    await tx.wait();
    alert('Judgment submitted on-chain.');
    clearJudgmentForm();
    await fetchAllCases();
    populateCourtLists();
  }catch(err){
    console.error(err);
    alert('Error submitting judgment: ' + (err?.message || err));
  }
}

/* Fetch all cases (view) — returns parsed array for other code to use */
async function fetchAllCases(){
  try{
    let raw;
    if(contract){
      raw = await contract.getAllCases();
    } else if(window.ethereum){
      const readProvider = new ethers.providers.Web3Provider(window.ethereum);
      const readContract = new ethers.Contract(contractAddress, contractABI, readProvider);
      raw = await readContract.getAllCases();
    } else {
      // no provider, return empty array (public without provider)
      renderCases([]);
      return [];
    }
    const parsed = (raw || []).map(normalizeCase);
    renderCases(parsed);
    populateCourtListsFromArray(parsed);
    return parsed;
  }catch(err){
    console.error('fetchAllCases error', err);
    renderCases([]);
    return [];
  }
}

/* Search (filter client-side) */
async function searchCase(){
  const q = document.getElementById('searchTracking').value.trim().toLowerCase();
  const all = await fetchAllCases();
  if(!q){ renderCases(all); return; }
  const filtered = (all || []).filter(c =>
    (c.evidenceID||'').toLowerCase().includes(q) ||
    (c.aadhaar||'').toLowerCase().includes(q) ||
    (c.accused||'').toLowerCase().includes(q)
  );
  renderCases(filtered);
}

/* Fill judgment form by selected case (apply) */
function applySelectedCase(){
  const rawVal = document.getElementById('searchJudgment').value.trim();
  if(!rawVal){
    // if select is used
    const sel = document.getElementById('casesSelect').value;
    if(sel){
      const ev = sel.split('|')[0].trim();
      document.getElementById('evidenceID_j').value = ev;
    }
    return;
  }
  // rawVal could be "EV00001 | Name | Aadhaar" or just EV...
  const parts = rawVal.split('|').map(s=>s.trim());
  if(parts.length>0 && parts[0].startsWith('EV')) {
    document.getElementById('evidenceID_j').value = parts[0];
    return;
  }
  // attempt to interpret as evidence id if contains EV...
  const matchEv = rawVal.match(/EV[0-9]+/i);
  if(matchEv){ document.getElementById('evidenceID_j').value = matchEv[0].toUpperCase(); return; }
  // fallback: try to find case in current list
  const sel = document.getElementById('casesSelect');
  const foundOpt = Array.from(sel.options).find(o => o.text.toLowerCase().includes(rawVal.toLowerCase()));
  if(foundOpt){ sel.value = foundOpt.value; onCourtSelectionChange(); }
}

/* Populate court datalist & select */
async function populateCourtLists(){
  const all = await fetchAllCases();
  populateCourtListsFromArray(all);
}
function populateCourtListsFromArray(parsed){
  // datalist
  const datalist = document.getElementById('casesList');
  datalist.innerHTML = '';
  const select = document.getElementById('casesSelect');
  select.innerHTML = '<option value="">-- select a case --</option>';
  parsed.forEach(c=>{
    const display = `${c.evidenceID} | ${c.accused} | ${c.aadhaar}`;
    const opt = document.createElement('option');
    opt.value = display;
    opt.text = display;
    datalist.appendChild(opt);
    const selOpt = document.createElement('option');
    selOpt.value = display;
    selOpt.text = display;
    select.appendChild(selOpt);
  });
}

/* Filter court list while typing (basic) */
function filterCourtList(){
  const q = document.getElementById('searchJudgment').value.trim().toLowerCase();
  const select = document.getElementById('casesSelect');
  for(let i=0;i<select.options.length;i++){
    const opt = select.options[i];
    opt.style.display = (q === '' || opt.text.toLowerCase().includes(q)) ? 'block' : 'none';
  }
}

/* When a case is selected in the select element */
function onCourtSelectionChange(){
  const val = document.getElementById('casesSelect').value;
  if(!val) return;
  const ev = val.split('|')[0].trim();
  document.getElementById('evidenceID_j').value = ev;
}

/* When Aadhaar is blurred in register, try to auto-fill accused and regenerate IDs */
document.addEventListener('DOMContentLoaded', ()=>{
  const aadhaarInput = document.getElementById('aadhaar');
  if(aadhaarInput){
    aadhaarInput.addEventListener('blur', async ()=>{
      const aad = aadhaarInput.value.trim();
      if(!aad) return;
      const all = await fetchAllCases();
      const found = (all || []).find(c => (c.aadhaar||'') === aad);
      if(found){
        document.getElementById('accusedName').value = found.accused || '';
      }
      // regenerate IDs (in case on-chain changed)
      await generateNextIDs();
    });
  }
});

/* Render cases into table */
function renderCases(rows){
  const tbody = document.getElementById('trackingResults');
  tbody.innerHTML = '';
  if(!rows || rows.length === 0){
    document.getElementById('trackingResultsTable').classList.add('hidden');
    document.getElementById('noCases').classList.remove('hidden');
    return;
  }
  rows.forEach(c=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="border p-2 font-mono">${escapeHtml(c.evidenceID)}</td>
      <td class="border p-2 font-mono">${escapeHtml(c.uniqueID)}</td>
      <td class="border p-2">${escapeHtml(c.aadhaar)}</td>
      <td class="border p-2">${escapeHtml(c.accused)}</td>
      <td class="border p-2">${escapeHtml(c.caseDetail)}</td>
      <td class="border p-2">${escapeHtml(c.location)}</td>
      <td class="border p-2">${escapeHtml(c.crimeDateTime)}</td>
      <td class="border p-2">${escapeHtml(c.registrationDateTime)}</td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById('trackingResultsTable').classList.remove('hidden');
  document.getElementById('noCases').classList.add('hidden');
}

/* Simple escaping */
function escapeHtml(s){ if(s === null || s === undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }

/* Increment local counters after successful register */
function incrementLocalCounters(){
  const ev = getLocalCounter(LOCAL_EVIDENCE_KEY,1);
  const ui = getLocalCounter(LOCAL_UNIQUE_KEY,1);
  setLocalCounter(LOCAL_EVIDENCE_KEY, ev+1);
  setLocalCounter(LOCAL_UNIQUE_KEY, ui+1);
}

/* Init UI on load */
window.onload = function(){
  document.getElementById('loginPage').style.display = 'flex';
  document.getElementById('dashboard').style.display = 'none';
  setWalletUI(null);
  // hide wallet dropdown on outside click
  document.addEventListener('click', function(e){
    const dropdown = document.getElementById('walletDropdown');
    const btn = document.getElementById('walletConnectTopBtn');
    if(!btn.contains(e.target) && !dropdown.contains(e.target)){
      dropdown.classList.add('hidden');
    }
  });
};
</script>

</body>
</html>
