<!-- Save as index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Evidence Tracking — Police · Court · Public</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
  <style>
    /* [STYLES UNCHANGED - KEEP AS IS] */
    /* ... your existing CSS remains the same ... */
  </style>
</head>
<body>
<div class="wrap">
  <!-- [UI remains unchanged] -->
  <!-- Only login logic and credential data has changed -->
</div>

<script>
/* ========= Real login credentials ========= */
const POLICE_USERS = {
  'STN-001': 'pass001',
  'STN-002': 'pass002',
  'STN-003': 'pass003'
};

const COURT_USERS = {
  'CRT-001': 'courtpass1',
  'CRT-002': 'courtpass2',
  'CRT-003': 'courtpass3'
};

/* ========= State ========= */
let web3, accounts, contract;
let CONTRACT_ADDRESS = "";
let CONTRACT_ABI = [];
let localEvidenceCache = [];

const AUTH_KEYS = {
  police: 'evi_auth_police',
  court:  'evi_auth_court'
};

/* ========= UI Refs ========= */
const connectBtn = document.getElementById('connectBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const acctSpan = document.getElementById('acctSpan');

const roleSel = document.getElementById('roleSel');
const showPublicBtn = document.getElementById('showPublicBtn');

const contractAddrInput = document.getElementById('contractAddress');
const contractAbiInput = document.getElementById('contractAbi');
const saveContractBtn = document.getElementById('saveContractBtn');
const loadDemoBtn = document.getElementById('loadDemoBtn');
const contractMsg = document.getElementById('contractMsg');

/* Login cards */
const policeLogin = document.getElementById('policeLogin');
const courtLogin  = document.getElementById('courtLogin');
const policeStationId = document.getElementById('policeStationId');
const policePass  = document.getElementById('policePass');
const courtId     = document.getElementById('courtId');
const courtPass   = document.getElementById('courtPass');
const policeLoginBtn = document.getElementById('policeLoginBtn');
const policeCancelBtn= document.getElementById('policeCancelBtn');
const courtLoginBtn  = document.getElementById('courtLoginBtn');
const courtCancelBtn = document.getElementById('courtCancelBtn');

/* Portals */
const policePage = document.getElementById('policePage');
const courtPage  = document.getElementById('courtPage');
const publicPage = document.getElementById('publicPage');
const resultsCard = document.getElementById('resultsCard');
const resultsOutput = document.getElementById('resultsOutput');

/* Logout buttons inside portals */
const policeLogoutBtn = document.getElementById('policeLogoutBtn');
const courtLogoutBtn  = document.getElementById('courtLogoutBtn');

/* Police fields */
const p_aadhaar=document.getElementById('p_aadhaar');
const p_accused=document.getElementById('p_accused');
const p_detail=document.getElementById('p_detail');
const p_location=document.getElementById('p_location');
const p_officer=document.getElementById('p_officer');
const p_crime=document.getElementById('p_crime');
const p_reg=document.getElementById('p_reg');
const p_unique=document.getElementById('p_unique');
const p_evidence=document.getElementById('p_evidence');
const registerBtn=document.getElementById('registerBtn');
const clearPoliceBtn=document.getElementById('clearPoliceBtn');
const policeTrackInput=document.getElementById('policeTrackInput');
const policeTrackBtn=document.getElementById('policeTrackBtn');

/* Court fields */
const courtSelect=document.getElementById('courtSelect');
const courtManual=document.getElementById('courtManual');
const courtJudgment=document.getElementById('courtJudgment');
const courtClosing=document.getElementById('courtClosing');
const submitJudgmentBtn=document.getElementById('submitJudgmentBtn');
const addReviewBtn=document.getElementById('addReviewBtn');
const courtTrackInput=document.getElementById('courtTrackInput');
const courtTrackBtn=document.getElementById('courtTrackBtn');

/* Public */
const publicInput=document.getElementById('publicInput');
const publicTrackBtn=document.getElementById('publicTrackBtn');
const publicOutput=document.getElementById('publicOutput');

/* ========= Helpers ========= */
const methodExists = (name)=> contract?.methods && contract.methods[name];
const tryCall = async (fn, args=[]) => {
  try { return await fn(...args).call(); } catch(_){ return null; }
};
const saveToLocal = ()=> {
  localStorage.setItem('evi_addr', contractAddrInput.value.trim());
  localStorage.setItem('evi_abi', contractAbiInput.value.trim());
};
const loadFromLocal = ()=> {
  const a = localStorage.getItem('evi_addr')||'';
  const abi = localStorage.getItem('evi_abi')||'';
  if(a) contractAddrInput.value=a;
  if(abi) contractAbiInput.value=abi;
  if(a||abi) contractMsg.innerText='Loaded last used values into the form.';
};

function isAuthed(role){ return sessionStorage.getItem(AUTH_KEYS[role]) === '1'; }
function setAuthed(role, val){ sessionStorage.setItem(AUTH_KEYS[role], val ? '1':'0'); }

function showOnly(el){ el.classList.add('active'); }
function hideAllPortalsAndLogins(){
  [policePage,courtPage,publicPage].forEach(p=>p.classList.remove('active'));
  [policeLogin,courtLogin].forEach(l=>l.classList.remove('active'));
}
function routeForRole(role){
  hideAllPortalsAndLogins();
  resultsCard.style.display = role ? 'block' : 'none';

  if(!role){ return; }

  if(role==='public'){
    showOnly(publicPage);
    return;
  }

  if(!web3 || !accounts || !accounts.length){
    alert('Connect wallet first.');
    return;
  }

  if(role==='police'){
    if(isAuthed('police')) { showOnly(policePage); }
    else { showOnly(policeLogin); }
  }

  if(role==='court'){
    if(isAuthed('court')) { showOnly(courtPage); }
    else { showOnly(courtLogin); }
  }
}

async function detectAnyEnumeration(){
  if(!contract) return [];
  if(methodExists('getAllEvidenceIds')){
    const list = await tryCall(contract.methods.getAllEvidenceIds);
    return Array.isArray(list) ? list : [];
  }
  return localEvidenceCache;
}

async function refreshEvidenceSelect(){
  if(!contract){ courtSelect.innerHTML='<option value="">-- none --</option>'; return; }
  let ids = [];
  if(methodExists('getAllEvidenceIds')){
    try{ ids = await contract.methods.getAllEvidenceIds().call(); }
    catch(_){ ids = []; }
  } else {
    ids = localEvidenceCache || [];
  }
  courtSelect.innerHTML = '<option value="">-- none --</option>';
  (ids||[]).forEach(id=>{
    const opt=document.createElement('option');
    opt.value=id; opt.text=id;
    courtSelect.appendChild(opt);
  });
}

/* ========= Role routing ========= */
roleSel.addEventListener('change', ()=> routeForRole(roleSel.value));
showPublicBtn.addEventListener('click', ()=>{ roleSel.value='public'; routeForRole('public'); });

/* ========= Real Login flows ========= */
policeLoginBtn.addEventListener('click', ()=>{
  const stationId = policeStationId.value.trim();
  const pass = policePass.value.trim();
  if (!stationId) return alert('Enter Station ID');
  if (!POLICE_USERS[stationId]) return alert('Station ID not recognized.');
  if (POLICE_USERS[stationId] !== pass) return alert('Incorrect passcode.');
  setAuthed('police', true);
  policePass.value='';
  routeForRole('police');
});
policeCancelBtn.addEventListener('click', ()=>{ roleSel.value=''; routeForRole(''); });
policeLogoutBtn.addEventListener('click', ()=>{
  setAuthed('police', false);
  alert('Logged out of Police portal');
  routeForRole('police');
});

courtLoginBtn.addEventListener('click', ()=>{
  const courtCode = courtId.value.trim();
  const pass = courtPass.value.trim();
  if (!courtCode) return alert('Enter Court ID');
  if (!COURT_USERS[courtCode]) return alert('Court ID not recognized.');
  if (COURT_USERS[courtCode] !== pass) return alert('Incorrect passcode.');
  setAuthed('court', true);
  courtPass.value='';
  routeForRole('court');
});
courtCancelBtn.addEventListener('click', ()=>{ roleSel.value=''; routeForRole(''); });
courtLogoutBtn.addEventListener('click', ()=>{
  setAuthed('court', false);
  alert('Logged out of Court portal');
  routeForRole('court');
});

/* ========= On Load ========= */
loadFromLocal();

