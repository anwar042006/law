<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Blockchain Evidence Tracking</title>
<script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<style>
body { font-family: Arial, sans-serif; background: linear-gradient(to right,#2c3e50,#3498db); color:#fff; text-align:center; padding:20px;}
h2,h3 { margin:10px 0; }
.container { max-width:900px; margin:auto; background:#1e1e2f; padding:20px; border-radius:12px; box-shadow:0px 0px 15px rgba(0,0,0,0.5);}
label { display:block; margin:10px 0 5px; font-weight:bold; text-align:left; }
input, select, textarea { width:95%; padding:8px; margin:5px 0 15px; border-radius:6px; border:none; }
textarea { resize:vertical; }
button { padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-size:15px; font-weight:bold; }
button:hover { opacity:0.9; }
.hidden { display:none; }
.role-btn { background:#e67e22; margin:5px; color:#000; }
.logout-btn { background:#e74c3c; color:#fff; margin-top:15px; }
.track-section { background:#2c2c3c; padding:15px; border-radius:10px; margin-top:20px; text-align:left;}
.readonly { background: rgba(255,255,255,0.2); }
</style>
</head>
<body>

<div class="container">
<h1><i class="fas fa-balance-scale"></i> Evidence Tracking System</h1>

<!-- Role Selection -->
<div id="roleSelect">
  <h2>Select Role</h2>
  <button class="role-btn" onclick="showLogin('police')"><i class="fas fa-user-shield"></i> Police</button>
  <button class="role-btn" onclick="showLogin('court')"><i class="fas fa-gavel"></i> Court</button>
  <button class="role-btn" onclick="showPortal('public')"><i class="fas fa-globe"></i> Public</button>
</div>

<!-- Police Login -->
<div id="policeLogin" class="hidden">
  <h2><i class="fas fa-user-shield"></i> Police Login</h2>
  <input type="text" id="policeUser" placeholder="ğŸ‘¤ Username">
  <input type="password" id="policePass" placeholder="ğŸ”‘ Password">
  <button onclick="login('police')">Login</button>
</div>

<!-- Police Portal -->
<div id="policePortal" class="hidden">
<h2><i class="fas fa-user-shield"></i> Police Portal</h2>

<label>ğŸ†” Aadhaar ID</label><input type="text" id="aadhaarID" placeholder="Enter Aadhaar">

<label>ğŸ‘¤ Accused Name</label><input type="text" id="accusedName" placeholder="Enter Accused">

<label>ğŸ“„ Case Details</label><textarea id="caseDetails" placeholder="Enter case details"></textarea>

<label>ğŸ“ Location</label><input type="text" id="location" placeholder="Enter location">

<label>ğŸ‘® Officer Name</label><input type="text" id="officerName" placeholder="Enter officer name">

<label>ğŸ“… Crime Date & Time</label>
<input type="datetime-local" id="crimeDateTime">

<label>ğŸ“ Case Registration Date & Time</label>
<input type="text" id="registerDateTime" readonly class="readonly">

<label>ğŸ”‘ Evidence ID</label>
<input type="text" id="evidenceID" readonly class="readonly">

<label>ğŸ“Œ Unique Case ID</label>
<input type="text" id="uniqueCaseID" readonly class="readonly">

<button onclick="registerCase()">Register Case</button>

<div class="track-section">
<h3>ğŸ” Track Case</h3>
<label>Search by Evidence ID / Accused Name / Aadhaar</label>
<input type="text" id="trackPolice" placeholder="Enter value">
<button onclick="searchPolice()">Search</button>
<pre id="policeTrackResult"></pre>
</div>

<button class="logout-btn" onclick="logout()">ğŸšª Logout</button>
</div>

<!-- Court Login -->
<div id="courtLogin" class="hidden">
  <h2><i class="fas fa-gavel"></i> Court Login</h2>
  <input type="text" id="courtUser" placeholder="ğŸ‘¤ Username">
  <input type="password" id="courtPass" placeholder="ğŸ”‘ Password">
  <button onclick="login('court')">Login</button>
</div>

<!-- Court Portal -->
<div id="courtPortal" class="hidden">
<h2><i class="fas fa-gavel"></i> Court Portal</h2>
<label>ğŸ” Search by Evidence ID / Accused Name / Aadhaar</label>
<input type="text" id="trackCourt" placeholder="Enter value">
<button onclick="searchCourt()">Search</button>
<label>ğŸ“‘ Select Evidence</label>
<select id="evidenceSelect" onchange="showSelectedCase()"></select>
<label>ğŸ“œ Judgment Text</label><textarea id="judgment"></textarea>
<label>ğŸ“… Closing Date</label><input type="date" id="closingDate">
<label>ğŸ”„ Rejudgment (if any)</label><textarea id="rejudgment"></textarea>
<button onclick="submitJudgment()">Submit Judgment</button>

<div class="track-section">
<h3>ğŸ” Track Case</h3>
<pre id="courtTrackResult"></pre>
</div>

<button class="logout-btn" onclick="logout()">ğŸšª Logout</button>
</div>

<!-- Public Portal -->
<div id="publicPortal" class="hidden">
<h2><i class="fas fa-globe"></i> Public Case Tracking</h2>
<label>ğŸ” Search by Evidence ID / Accused Name / Aadhaar</label>
<input type="text" id="trackPublic" placeholder="Enter value">
<button onclick="searchPublic()">Search</button>

<div class="track-section">
<h3>ğŸ“‚ Case Details</h3>
<pre id="publicTrackResult"></pre>
</div>

<button class="logout-btn" onclick="logout()">ğŸšª Back</button>
</div>

</div>

<script>
let accounts;
let contract;
let courtCases = [];
const contractAddress = "0xc7387e1490B195cA00be8Df21692e39Aceeb4fdE";
const abi = [
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "uniqueCaseID",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "aadhaar",
				"type": "string"
			}
		],
		"name": "CaseRegistered",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			}
		],
		"name": "JudgmentSubmitted",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "aadhaar",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "accused",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "details",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "location",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "officer",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "crimeDate",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "regDate",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "uniqueCaseID",
				"type": "string"
			}
		],
		"name": "registerCase",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "judgmentText",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "closingDate",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "rejudgment",
				"type": "string"
			}
		],
		"name": "submitJudgment",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"name": "aadhaarAccused",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "aadhaarCases",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "aadhaarCasesKeys",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"name": "aadhaarUniqueID",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"name": "cases",
		"outputs": [
			{
				"internalType": "string",
				"name": "uniqueCaseID",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "aadhaar",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "accused",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "details",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "location",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "officer",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "crimeDate",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "regDate",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"name": "judgments",
		"outputs": [
			{
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "judgmentText",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "closingDate",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "rejudgment",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "totalAadhaarKeys",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "aadhaar",
				"type": "string"
			}
		],
		"name": "trackByAadhaar",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "uniqueCaseID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "aadhaar",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "accused",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "details",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "location",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "officer",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "crimeDate",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "regDate",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.Case[]",
				"name": "",
				"type": "tuple[]"
			},
			{
				"components": [
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "judgmentText",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "closingDate",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "rejudgment",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.Judgment[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "accusedName",
				"type": "string"
			}
		],
		"name": "trackByAccused",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "uniqueCaseID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "aadhaar",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "accused",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "details",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "location",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "officer",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "crimeDate",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "regDate",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.Case[]",
				"name": "",
				"type": "tuple[]"
			},
			{
				"components": [
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "judgmentText",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "closingDate",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "rejudgment",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.Judgment[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			}
		],
		"name": "trackByEvidenceID",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "uniqueCaseID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "aadhaar",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "accused",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "details",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "location",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "officer",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "crimeDate",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "regDate",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.Case",
				"name": "",
				"type": "tuple"
			},
			{
				"components": [
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "judgmentText",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "closingDate",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "rejudgment",
						"type": "string"
					}
				],
				"internalType": "struct EvidenceTracking.Judgment",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

// Counters for local UI IDs
let evidenceCounter = 0;
let caseCounter = 0;
function generateID(prefix, counter){ return prefix + String(counter).padStart(6,"0"); }

function normalizeCase(c){
    return {
        aadhaar: c.aadhaar || c[0] || "",
        accused: c.accused || c[1] || "",
        details: c.details || c[2] || "",
        location: c.location || c[3] || "",
        officer: c.officer || c[4] || "",
        crimeDate: c.crimeDate || c[5] || "",
        registerDate: c.registerDate || c[6] || "",
        evidenceID: c.evidenceID || c[7] || "",
        uniqueCaseID: c.uniqueCaseID || c[8] || "",
        judgment: c.judgment || c[9] || "",
        closingDate: c.closingDate || c[10] || "",
        rejudgment: c.rejudgment || c[11] || ""
    };
}

async function loadWeb3(){
    if(window.ethereum){
        window.web3 = new Web3(window.ethereum);
        await window.ethereum.enable();
        accounts = await web3.eth.getAccounts();
        contract = new web3.eth.Contract(abi, contractAddress);
    } else { alert("Please install MetaMask!"); }
}

function showLogin(role){
    document.getElementById('roleSelect').classList.add('hidden');
    if(role==='police'){
        document.getElementById('policeLogin').classList.remove('hidden');
        document.getElementById('registerDateTime').value = new Date().toLocaleString();
        evidenceCounter++; caseCounter++;
        document.getElementById('evidenceID').value = generateID("EV", evidenceCounter);
        document.getElementById('uniqueCaseID').value = generateID("UI", caseCounter);
    }
    if(role==='court') document.getElementById('courtLogin').classList.remove('hidden');
}
function showPortal(role){
    document.getElementById('roleSelect').classList.add('hidden');
    if(role==='public') document.getElementById('publicPortal').classList.remove('hidden');
}

function login(role){
    if(role==='police'){
        if(document.getElementById('policeUser').value==='police1' && document.getElementById('policePass').value==='1234'){
            document.getElementById('policeLogin').classList.add('hidden');
            document.getElementById('policePortal').classList.remove('hidden');
        } else alert("âŒ Invalid Police credentials!");
    }
    if(role==='court'){
        if(document.getElementById('courtUser').value==='court1' && document.getElementById('courtPass').value==='1234'){
            document.getElementById('courtLogin').classList.add('hidden');
            document.getElementById('courtPortal').classList.remove('hidden');
        } else alert("âŒ Invalid Court credentials!");
    }
}

function logout(){
    document.querySelectorAll('#policeLogin,#policePortal,#courtLogin,#courtPortal,#publicPortal')
    .forEach(el=>el.classList.add('hidden'));
    document.getElementById('roleSelect').classList.remove('hidden');
}

// --- POLICE ---
async function registerCase(){
    const aadhaar = document.getElementById('aadhaarID').value.trim();
    const accused = document.getElementById('accusedName').value.trim();
    const details = document.getElementById('caseDetails').value.trim();
    const location = document.getElementById('location').value.trim();
    const officer = document.getElementById('officerName').value.trim();
    const crimeDate = document.getElementById('crimeDateTime').value;
    const registerDate = document.getElementById('registerDateTime').value;
    const evidenceID = document.getElementById('evidenceID').value;
    const uniqueCaseID = document.getElementById('uniqueCaseID').value;

    if(!aadhaar || !accused){ alert("âš  Aadhaar and Accused required"); return; }

    try{
        await contract.methods.registerCase(aadhaar, accused, details, location, officer, crimeDate, registerDate, evidenceID, uniqueCaseID)
        .send({from: accounts[0]});
        alert("âœ… Case Registered!");
    } catch(e){ console.error(e); alert("âŒ Transaction Failed: " + e.message); }
}

// Reusable search function
async function fetchCase(query){
    try{ return [normalizeCase(await contract.methods.trackByEvidenceID(query).call())]; }
    catch{}
    try{ return (await contract.methods.trackByAccused(query).call()).map(normalizeCase); }
    catch{}
    try{ return (await contract.methods.trackByAadhaar(query).call()).map(normalizeCase); }
    catch{}
    return [];
}

// POLICE SEARCH
async function searchPolice(){
    const query = document.getElementById('trackPolice').value.trim();
    let results = await fetchCase(query);
    document.getElementById('policeTrackResult').innerText = JSON.stringify(results,null,2);
}

// COURT SEARCH
async function searchCourt(){
    const query = document.getElementById('trackCourt').value.trim();
    courtCases = await fetchCase(query);
    populateEvidenceDropdown(courtCases);
    document.getElementById('courtTrackResult').innerText = JSON.stringify(courtCases,null,2);
}

function populateEvidenceDropdown(caseArray){
    const select = document.getElementById('evidenceSelect');
    select.innerHTML = "";
    caseArray.forEach(c=>{
        let opt = document.createElement('option');
        opt.value = c.evidenceID;
        opt.text = `${c.evidenceID} | ${c.accused} | ${c.uniqueCaseID}`;
        select.add(opt);
    });
    if(caseArray.length>0) showSelectedCase();
}

function showSelectedCase(){
    const eid = document.getElementById('evidenceSelect').value;
    const found = courtCases.find(c=>c.evidenceID===eid);
    if(found){
        document.getElementById('courtTrackResult').innerText = JSON.stringify(found,null,2);
        document.getElementById('judgment').value = found.judgment || "";
        document.getElementById('closingDate').value = found.closingDate || "";
        document.getElementById('rejudgment').value = found.rejudgment || "";
    }
}

async function submitJudgment(){
    const eid = document.getElementById('evidenceSelect').value;
    const judgment = document.getElementById('judgment').value;
    const closingDate = document.getElementById('closingDate').value;
    const rejudgment = document.getElementById('rejudgment').value;
    if(!eid){ alert("âš  Select Evidence"); return; }
    try{
        await contract.methods.submitJudgment(eid, judgment, closingDate, rejudgment).send({from: accounts[0]});
        alert("âœ… Judgment Submitted!");
    } catch(e){ console.error(e); alert("âŒ Transaction Failed"); }
}

// PUBLIC SEARCH
async function searchPublic(){
    const query = document.getElementById('trackPublic').value.trim();
    let results = await fetchCase(query);
    document.getElementById('publicTrackResult').innerText = JSON.stringify(results,null,2);
}

window.onload = loadWeb3;
</script>

</body>
</html>
