<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Blockchain Evidence Tracking â€” Updated</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<style>
body { font-family: Arial, sans-serif; background: linear-gradient(to right,#2c3e50,#3498db); color:#fff; text-align:center; padding:20px;}
h2,h3 { margin:10px 0; }
.container { max-width:920px; margin:auto; background:#1e1e2f; padding:20px; border-radius:12px; box-shadow:0px 0px 15px rgba(0,0,0,0.5);}
label { display:block; margin:10px 0 5px; font-weight:bold; text-align:left; }
input, select, textarea { width:95%; padding:8px; margin:5px 0 15px; border-radius:6px; border:none; }
textarea { resize:vertical; min-height:70px; }
button { padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-size:15px; font-weight:bold; }
button:hover { opacity:0.9; }
.hidden { display:none; }
.role-btn { background:#e67e22; margin:5px; color:#000; }
.logout-btn { background:#e74c3c; color:#fff; margin-top:15px; }
.track-section { background:#2c2c3c; padding:15px; border-radius:10px; margin-top:20px; text-align:left;}
.readonly { background: rgba(255,255,255,0.12); }
.small { font-size:12px; opacity:0.9; }
pre { background:#111; padding:10px; border-radius:8px; color:#0f0; white-space:pre-wrap; text-align:left; max-height:320px; overflow:auto; }
.flex { display:flex; gap:10px; align-items:center; justify-content:flex-start; flex-wrap:wrap; }
.pill { padding:6px 10px; border-radius:999px; background:#333; }
@media (max-width:600px){ input,select,textarea{width:100%} .container{padding:12px}}
</style>
</head>
<body>

<div class="container">
  <h1><i class="fas fa-balance-scale"></i> Evidence Tracking System</h1>

  <!-- Role Selection -->
  <div id="roleSelect">
    <h2>Select Role</h2>
    <button class="role-btn" onclick="showLogin('police')"><i class="fas fa-user-shield"></i> Police</button>
    <button class="role-btn" onclick="showLogin('court')"><i class="fas fa-gavel"></i> Court</button>
    <button class="role-btn" onclick="showPortal('public')"><i class="fas fa-globe"></i> Public</button>
  </div>

  <!-- Police Login -->
  <div id="policeLogin" class="hidden">
    <h2><i class="fas fa-user-shield"></i> Police Login</h2>
    <input type="text" id="policeUser" placeholder="Username">
    <input type="password" id="policePass" placeholder="Password">
    <div class="flex">
      <button onclick="login('police')">Login</button>
    </div>
  </div>

  <!-- Court Login -->
  <div id="courtLogin" class="hidden">
    <h2><i class="fas fa-gavel"></i> Court Login</h2>
    <input type="text" id="courtUser" placeholder="Username">
    <input type="password" id="courtPass" placeholder="Password">
    <div class="flex">
      <button onclick="login('court')">Login</button>
    </div>
  </div>

  <!-- Police Portal -->
  <div id="policePortal" class="hidden">
    <h2><i class="fas fa-user-shield"></i> Police Portal</h2>

    <label>ğŸ†” Aadhaar ID (12 digits)</label><input type="text" id="aadhaar" pattern="\d{12}" placeholder="e.g. 123412341234">
    <label>ğŸ‘¤ Accused Name</label><input type="text" id="accused">
    <label>ğŸ“„ Case Details</label><textarea id="caseDetails"></textarea>
    <label>ğŸ“ Location</label><input type="text" id="location">
    <label>ğŸ‘® Officer Name</label><input type="text" id="officer">
    <div class="flex">
      <div style="flex:1">
        <label>ğŸ•’ Crime Date/Time</label>
        <input type="datetime-local" id="crimeDate">
      </div>
      <div style="flex:1">
        <label>ğŸ“ Registration Date/Time</label>
        <input type="datetime-local" id="regDate">
      </div>
    </div>
    <div class="flex">
      <div style="flex:1">
        <label>ğŸ†” Unique Case ID</label><input type="text" id="uniqueCaseID" class="readonly" readonly>
      </div>
      <div style="flex:1">
        <label>ğŸ”– Evidence ID</label><input type="text" id="evidenceID" class="readonly" readonly>
      </div>
    </div>

    <div class="flex">
      <button onclick="registerCase()">Register Case</button>
      <button onclick="downloadCases()" class="pill small">Export JSON</button>
      <button onclick="importCases()" class="pill small">Import JSON</button>
    </div>

    <div class="track-section">
      <h3>ğŸ” Track Case</h3>
      <p class="small">Search by Evidence ID (EV00001), Accused Name, or Aadhaar ID</p>
      <div class="flex">
        <input type="text" id="trackPolice" placeholder="Enter Evidence ID / Accused Name / Aadhaar">
        <button onclick="trackCase('police')">Track</button>
        <button onclick="clearTrackResults('police')" class="pill small">Clear</button>
      </div>
      <pre id="policeTrackResult">{ }</pre>
    </div>

    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <!-- Court Portal -->
  <div id="courtPortal" class="hidden">
    <h2><i class="fas fa-gavel"></i> Court Portal</h2>

    <label>ğŸ” Search by Evidence ID / Accused Name / Aadhaar</label>
    <div class="flex">
      <input type="text" id="trackCourt" placeholder="Enter Evidence ID / Accused Name / Aadhaar">
      <button onclick="searchCourt()">Search</button>
      <button onclick="clearTrackResults('court')" class="pill small">Clear</button>
    </div>

    <label>ğŸ”– Select Evidence</label>
    <select id="evidenceSelect"></select>

    <label>ğŸ“ Judgment Text</label><textarea id="judgment"></textarea>
    <label>ğŸ“… Closing Date</label><input type="date" id="closingDate">
    <div class="flex">
      <button onclick="submitJudgment()">Submit Judgment</button>
      <button onclick="populateAllEvidence()" class="pill small">Load All Evidence</button>
    </div>

    <div class="track-section">
      <h3>ğŸ” Track Case</h3>
      <pre id="courtTrackResult">{ }</pre>
    </div>

    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <!-- Public Portal -->
  <div id="publicPortal" class="hidden">
    <h2><i class="fas fa-globe"></i> Public Portal</h2>
    <div class="track-section">
      <h3>ğŸ” Track Case</h3>
      <p class="small">Search by Evidence ID, Accused Name, or Aadhaar ID</p>
      <div class="flex">
        <input type="text" id="trackPublic" placeholder="Enter Evidence ID / Accused Name / Aadhaar">
        <button onclick="trackCase('public')">Track</button>
        <button onclick="clearTrackResults('public')" class="pill small">Clear</button>
      </div>
      <pre id="publicTrackResult">{ }</pre>
    </div>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
</div>

<script>
// Web3 placeholders
const contractAddress = "0x2B04cdb9E179B706cd1c83C2dCb72bf5AAe4b8EB"; 
const abi = [
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "aadhaar",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "accused",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "caseDetail",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "location",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "officer",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "crimeDate",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "regDate",
				"type": "string"
			}
		],
		"name": "registerCase",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "text",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "closingDate",
				"type": "string"
			}
		],
		"name": "submitJudgment",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getAllEvidence",
		"outputs": [
			{
				"internalType": "string[]",
				"name": "",
				"type": "string[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "evidenceID",
				"type": "string"
			}
		],
		"name": "getCaseByEvidence",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "aadhaar",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "accused",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "caseDetail",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "location",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "officer",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "crimeDate",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "regDate",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "uniqueCaseID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"components": [
							{
								"internalType": "string",
								"name": "text",
								"type": "string"
							},
							{
								"internalType": "string",
								"name": "closingDate",
								"type": "string"
							},
							{
								"internalType": "uint256",
								"name": "timestamp",
								"type": "uint256"
							}
						],
						"internalType": "struct EvidenceTracking.Judgment[]",
						"name": "judgments",
						"type": "tuple[]"
					}
				],
				"internalType": "struct EvidenceTracking.Case",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "aadhaar",
				"type": "string"
			}
		],
		"name": "getCasesByAadhaar",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "aadhaar",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "accused",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "caseDetail",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "location",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "officer",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "crimeDate",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "regDate",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "uniqueCaseID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"components": [
							{
								"internalType": "string",
								"name": "text",
								"type": "string"
							},
							{
								"internalType": "string",
								"name": "closingDate",
								"type": "string"
							},
							{
								"internalType": "uint256",
								"name": "timestamp",
								"type": "uint256"
							}
						],
						"internalType": "struct EvidenceTracking.Judgment[]",
						"name": "judgments",
						"type": "tuple[]"
					}
				],
				"internalType": "struct EvidenceTracking.Case[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "accused",
				"type": "string"
			}
		],
		"name": "getCasesByAccused",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "aadhaar",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "accused",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "caseDetail",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "location",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "officer",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "crimeDate",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "regDate",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "uniqueCaseID",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "evidenceID",
						"type": "string"
					},
					{
						"components": [
							{
								"internalType": "string",
								"name": "text",
								"type": "string"
							},
							{
								"internalType": "string",
								"name": "closingDate",
								"type": "string"
							},
							{
								"internalType": "uint256",
								"name": "timestamp",
								"type": "uint256"
							}
						],
						"internalType": "struct EvidenceTracking.Judgment[]",
						"name": "judgments",
						"type": "tuple[]"
					}
				],
				"internalType": "struct EvidenceTracking.Case[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "totalCases",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];
let web3; let accounts = []; let contract = null;

function ensureData(){ if(!localStorage.getItem('ets_cases')) localStorage.setItem('ets_cases',JSON.stringify([])); if(!localStorage.getItem('ets_meta')) localStorage.setItem('ets_meta',JSON.stringify({nextUI:1,nextEV:1})); }
function getCases(){ ensureData(); return JSON.parse(localStorage.getItem('ets_cases')); }
function setCases(c){ localStorage.setItem('ets_cases',JSON.stringify(c)); }
function getMeta(){ ensureData(); return JSON.parse(localStorage.getItem('ets_meta')); }
function setMeta(m){ localStorage.setItem('ets_meta',JSON.stringify(m)); }
function formatUI(n){ return 'UI'+String(n).padStart(5,'0'); }
function formatEV(n){ return 'EV'+String(n).padStart(5,'0'); }
function nextIDs(){ const m=getMeta(); const ui=formatUI(m.nextUI); const ev=formatEV(m.nextEV); m.nextUI++; m.nextEV++; setMeta(m); return {ui,ev}; }

window.onload = () => { attachAadhaarListener(); populateAllEvidence(); };

// Login / session
function showLogin(role){ document.getElementById('roleSelect').classList.add('hidden'); if(role==='police') document.getElementById('policeLogin').classList.remove('hidden'); if(role==='court') document.getElementById('courtLogin').classList.remove('hidden'); }
function showPortal(role){ document.getElementById('roleSelect').classList.add('hidden'); if(role==='public') document.getElementById('publicPortal').classList.remove('hidden'); }
function login(role){
  if(role==='police'){ const u=document.getElementById('policeUser').value.trim(); const p=document.getElementById('policePass').value.trim();
    if((u==='police1'&&p==='1234')||u.startsWith('police')){ alert('Police Login Successful'); document.getElementById('policeLogin').classList.add('hidden'); document.getElementById('policePortal').classList.remove('hidden'); } else alert('Invalid Police credentials!'); }
  if(role==='court'){ const u=document.getElementById('courtUser').value.trim(); const p=document.getElementById('courtPass').value.trim();
    if((u==='court1'&&p==='1234')||u.startsWith('court')){ alert('Court Login Successful'); document.getElementById('courtLogin').classList.add('hidden'); document.getElementById('courtPortal').classList.remove('hidden'); populateAllEvidence(); } else alert('Invalid Court credentials!'); }
}
function logout(){ ['policeLogin','courtLogin','policePortal','courtPortal','publicPortal'].forEach(id=>document.getElementById(id).classList.add('hidden')); document.getElementById('roleSelect').classList.remove('hidden'); alert("Logged out"); }

// Aadhaar behavior
function attachAadhaarListener(){
  const aad=document.getElementById('aadhaar'); if(!aad) return;
  aad.addEventListener('blur',()=>{ checkAadhaarAndFill(); });
  aad.addEventListener('input',()=>{ if(aad.value.trim()===''){ document.getElementById('accused').readOnly=false; document.getElementById('accused').value=''; } });
}
function checkAadhaarAndFill(){
  const aad = document.getElementById('aadhaar').value.trim(); if(!aad) return;
  const cs=getCases(); const found=cs.find(c=>c.aadhaar===aad);
  if(found){ document.getElementById('accused').value=found.accused; document.getElementById('accused').readOnly=true; }
  else document.getElementById('accused').readOnly=false;
}

// Register case
function registerCase(){
  const aad=document.getElementById('aadhaar').value.trim();
  const accused=document.getElementById('accused').value.trim();
  const details=document.getElementById('caseDetails').value.trim();
  const location=document.getElementById('location').value.trim();
  const officer=document.getElementById('officer').value.trim();
  const crimeDate=document.getElementById('crimeDate').value;
  const regDate=document.getElementById('regDate').value || new Date().toISOString();
  if(!aad || !accused || !details){ alert('Fill Aadhaar, Accused, Case'); return; }
  if(!/^\d{12}$/.test(aad) && !confirm('Aadhaar not 12 digits. Continue?')) return;
  const cs=getCases(); const existing = cs.filter(c=>c.aadhaar===aad);
  if(existing.length>0 && existing[0].accused.toLowerCase()!==accused.toLowerCase()){ alert('This Aadhaar is registered to a different accused!'); return; }
  const ids=nextIDs();
  const obj={aadhaar:aad,accused,details,location,officer,crimeDate,regDate,uniqueCaseID:ids.ui,evidenceID:ids.ev,judgments:[],createdAt:new Date().toISOString()};
  cs.push(obj); setCases(cs);
  document.getElementById('uniqueCaseID').value=obj.uniqueCaseID; document.getElementById('evidenceID').value=obj.evidenceID;
  alert('Case registered locally!'); clearPoliceFields(); populateAllEvidence();
}
function clearPoliceFields(){ ['aadhaar','accused','caseDetails','location','officer','crimeDate','regDate'].forEach(id=>document.getElementById(id).value=''); document.getElementById('accused').readOnly=false; }

// Tracking
function trackCase(role){
  const q=(role==='police')?document.getElementById('trackPolice').value.trim()
          :(role==='court')?document.getElementById('trackCourt').value.trim()
          :document.getElementById('trackPublic').value.trim();
  const cs=getCases(); const qL=q.toLowerCase();
  const res = cs.filter(c=>c.evidenceID.toLowerCase()===qL || c.accused.toLowerCase()===qL || c.aadhaar===q);
  const pre=(role==='police')?document.getElementById('policeTrackResult')
          :(role==='court')?document.getElementById('courtTrackResult')
          :document.getElementById('publicTrackResult');
  pre.textContent = res.length>0?JSON.stringify(res,null,2):"No cases found.";
}
function clearTrackResults(role){ (role==='police')?document.getElementById('policeTrackResult').textContent='{ }':
                                    (role==='court')?document.getElementById('courtTrackResult').textContent='{ }':
                                    document.getElementById('publicTrackResult').textContent='{ }'; }

// Court functions
function populateAllEvidence(){
  const sel=document.getElementById('evidenceSelect'); if(!sel) return;
  const cs=getCases(); sel.innerHTML='<option value="">Select Evidence</option>';
  cs.forEach(c=> sel.innerHTML+=`<option value="${c.evidenceID}">${c.evidenceID} - ${c.accused}</option>`);
}
function searchCourt(){ const input=document.getElementById('trackCourt').value.trim(); if(!input){ alert('Enter value'); return; }
  const cs=getCases(); const results=cs.filter(c=>c.evidenceID.toLowerCase()===input.toLowerCase() || c.accused.toLowerCase().includes(input.toLowerCase()) || c.aadhaar===input);
  document.getElementById('courtTrackResult').textContent=results.length>0?JSON.stringify(results,null,2):"No cases found.";
  if(results.length>0) document.getElementById('evidenceSelect').value=results[0].evidenceID;
}
function submitJudgment(){
  const eid=document.getElementById('evidenceSelect').value;
  const text=document.getElementById('judgment').value.trim();
  const date=document.getElementById('closingDate').value;
  if(!eid || !text || !date){ alert('Fill all fields'); return; }
  const cs=getCases(); const idx=cs.findIndex(c=>c.evidenceID===eid); if(idx===-1){ alert('Evidence not found'); return; }
  cs[idx].judgments.push({text,closingDate:date,submittedAt:new Date().toISOString()}); setCases(cs);
  alert('Judgment submitted!'); document.getElementById('judgment').value=''; document.getElementById('closingDate').value=''; populateAllEvidence();
}

// JSON Export / Import
function downloadCases(){ const data=JSON.stringify(getCases(),null,2); const blob=new Blob([data],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='cases.json'; a.click(); URL.revokeObjectURL(url);}
function importCases(){ const input=document.createElement('input'); input.type='file'; input.accept='application/json'; input.onchange=e=>{ const file=e.target.files[0]; const reader=new FileReader(); reader.onload=ev=>{ try{ const imported=JSON.parse(ev.target.result); setCases(getCases().concat(imported)); populateAllEvidence(); alert('Import done'); } catch(err){ alert('Invalid JSON'); } }; reader.readAsText(file); }; input.click(); }

</script>
</body>
</html>
