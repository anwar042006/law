<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Evidence Tracking — Police · Court · Public</title>
<script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
<style>
  :root{--bg:#071026;--card:#0f1724;--panel:#0b1220;--accent:#06b6d4;--accent2:#7c3aed;--muted:#94a3b8;--glass:rgba(255,255,255,0.05)}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#021226 0%, #071026 60%);color:#e6eef6;min-height:100vh;display:flex;justify-content:center;padding:28px}
  .wrap{width:100%;max-width:1100px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:12px}
  h1{margin:0;color:var(--accent);font-size:20px}
  .muted{color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:linear-gradient(180deg,var(--card),var(--panel));border:1px solid var(--glass);box-shadow:0 8px 40px rgba(2,6,23,.6);border-radius:12px;padding:16px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input,select,textarea,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.06);background:transparent;color:#e6eef6;font-size:14px;outline:none}
  textarea{min-height:96px;resize:vertical}
  .row{display:flex;gap:10px}
  .row>*{flex:1}
  button.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#021;font-weight:800;border:none;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,.1);color:var(--muted);cursor:pointer}
  button.small{padding:8px 10px;font-size:13px;border-radius:8px}
  pre.output{background:#041024;border:1px solid rgba(255,255,255,.06);padding:12px;border-radius:10px;white-space:pre-wrap;max-height:420px;overflow:auto}
  .full{grid-column:1 / -1}
  .portal{display:none}
  .portal.active{display:block}
  .loginCard{display:none}
  .loginCard.active{display:block}
  .loginHint{font-size:12px;color:var(--muted);margin-top:6px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Evidence Tracking System</h1>
      <div class="muted">Web3-enabled portal — Police · Court · Public</div>
    </div>
    <div style="text-align:right">
      <div class="muted">Wallet: <span id="acctSpan">not connected</span></div>
      <div style="height:8px"></div>
      <div class="row" style="gap:8px;justify-content:flex-end">
        <button id="connectBtn" class="small">Connect wallet</button>
        <button id="disconnectBtn" class="small ghost">Disconnect</button>
      </div>
    </div>
  </header>

  <!-- Top controls -->
  <div class="card">
    <div class="row">
      <div>
        <label>Role</label>
        <select id="roleSel">
          <option value="">-- choose role --</option>
          <option value="police">Police</option>
          <option value="court">Court</option>
          <option value="public">Public</option>
        </select>
      </div>
      <div>
        <label>Contract Address</label>
        <input id="contractAddress" placeholder="0x... (paste & Save + Test)"/>
      </div>
    </div>
    <label style="margin-top:10px">ABI (JSON array)</label>
    <textarea id="contractAbi" placeholder='Paste ABI JSON array here'></textarea>
    <div class="row" style="margin-top:8px">
      <button id="saveContractBtn" class="small">Save + Test</button>
      <button id="loadDemoBtn" class="small ghost">Load last used (if any)</button>
      <button id="showPublicBtn" class="small ghost">Open Public portal</button>
    </div>
    <div id="contractMsg" class="muted" style="margin-top:8px"></div>
  </div>

  <div class="grid" style="margin-top:16px">
    <!-- POLICE LOGIN -->
    <div id="policeLogin" class="card loginCard">
      <h3>Police — Login</h3>
      <label>Station ID</label>
      <input id="policeStationId" placeholder="e.g., STN-001" />
      <label>Passcode</label>
      <input id="policePass" type="password" placeholder="Enter police passcode" />
      <div class="row" style="margin-top:10px">
        <button id="policeLoginBtn" class="primary">Login</button>
        <button id="policeCancelBtn" class="ghost">Cancel</button>
      </div>
      <div class="loginHint">Demo passcode: <code>POLICE-1234</code> (change in script)</div>
    </div>

    <!-- COURT LOGIN -->
    <div id="courtLogin" class="card loginCard">
      <h3>Court — Login</h3>
      <label>Court ID</label>
      <input id="courtId" placeholder="e.g., CRT-001" />
      <label>Passcode</label>
      <input id="courtPass" type="password" placeholder="Enter court passcode" />
      <div class="row" style="margin-top:10px">
        <button id="courtLoginBtn" class="primary">Login</button>
        <button id="courtCancelBtn" class="ghost">Cancel</button>
      </div>
      <div class="loginHint">Demo passcode: <code>COURT-1234</code> (change in script)</div>
    </div>

    <!-- POLICE PORTAL -->
    <div id="policePage" class="card portal">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
        <h3 style="margin:0">Police — Register Case</h3>
        <button id="policeLogoutBtn" class="small ghost">Logout</button>
      </div>
      <label>Aadhaar ID</label><input id="p_aadhaar" placeholder="Aadhaar ID" />
      <label>Accused Name</label><input id="p_accused" placeholder="Full name" />
      <label>Case Detail</label><textarea id="p_detail" placeholder="Describe the case"></textarea>
      <label>Crime Location</label><input id="p_location" placeholder="City / address" />
      <label>Officer Name</label><input id="p_officer" placeholder="Officer name" />
      <div class="row">
        <div>
          <label>Crime Date & Time</label><input id="p_crime" type="datetime-local" />
        </div>
        <div>
          <label>Registration Date & Time</label><input id="p_reg" type="datetime-local" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>Unique Case ID (from contract)</label>
          <input id="p_unique" readonly />
        </div>
        <div>
          <label>Evidence ID (from contract)</label>
          <input id="p_evidence" readonly />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="registerBtn" class="primary">Register On-Chain</button>
        <button id="clearPoliceBtn" class="ghost">Clear</button>
      </div>
      <div class="muted" style="margin-top:8px">After a successful tx, Unique & Evidence IDs will auto-fill here instantly.</div>

      <hr style="border:none;height:1px;background:rgba(255,255,255,.08);margin:14px 0">
      <h4>Quick Track</h4>
      <div class="row">
        <input id="policeTrackInput" placeholder="EV00001 or accused or aadhaar"/>
        <button id="policeTrackBtn" class="small">Track</button>
      </div>
    </div>

    <!-- COURT PORTAL -->
    <div id="courtPage" class="card portal">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
        <h3 style="margin:0">Court — Judgment & Reviews</h3>
        <button id="courtLogoutBtn" class="small ghost">Logout</button>
      </div>
      <label>Select evidence</label>
      <select id="courtSelect"><option value="">-- none --</option></select>
      <label>Or enter Evidence ID / Accused / Aadhaar</label>
      <input id="courtManual" placeholder="EV00001 or Name or Aadhaar" />
      <label>Judgment text</label>
      <textarea id="courtJudgment" placeholder="Enter judgment/detail"></textarea>
      <label>Closing Date & Time</label>
      <input id="courtClosing" type="datetime-local" />
      <div class="row" style="margin-top:8px">
        <button id="submitJudgmentBtn" class="primary">Submit / Update Judgment</button>
        <button id="addReviewBtn" class="ghost">Add Review</button>
      </div>

      <hr style="border:none;height:1px;background:rgba(255,255,255,.08);margin:14px 0">
      <h4>Track</h4>
      <div class="row">
        <input id="courtTrackInput" placeholder="EV00001 or accused or aadhaar"/>
        <button id="courtTrackBtn" class="small">Track</button>
      </div>
    </div>

    <!-- PUBLIC -->
    <div id="publicPage" class="card portal">
      <h3>Public — Track Case</h3>
      <label>Evidence ID / Accused / Aadhaar</label>
      <div class="row">
        <input id="publicInput" placeholder="EV00001 or John Doe or Aadhaar" />
        <button id="publicTrackBtn" class="small">Track</button>
      </div>
      <div style="margin-top:14px"><pre id="publicOutput" class="output">No query yet.</pre></div>
    </div>

    <!-- RESULTS -->
    <div id="resultsCard" class="card full" style="display:none">
      <h3>Record / Reviews</h3>
      <pre id="resultsOutput" class="output">No results</pre>
    </div>
  </div>
</div>

<script>
/* ========= Demo passcodes (change for production) ========= */
const DEMO_POLICE_PASS = 'POLICE-1234';
const DEMO_COURT_PASS  = 'COURT-1234';

/* ========= State ========= */
let web3, accounts, contract;
let CONTRACT_ADDRESS = "";   // set via form
let CONTRACT_ABI = [];       // set via form
let localEvidenceCache = []; // optional fallback

/* Auth flags (kept in sessionStorage to persist across reloads in this tab) */
const AUTH_KEYS = {
  police: 'evi_auth_police',
  court:  'evi_auth_court'
};

/* ========= UI Refs ========= */
const connectBtn = document.getElementById('connectBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const acctSpan = document.getElementById('acctSpan');

const roleSel = document.getElementById('roleSel');
const showPublicBtn = document.getElementById('showPublicBtn');

const contractAddrInput = document.getElementById('contractAddress');
const contractAbiInput = document.getElementById('contractAbi');
const saveContractBtn = document.getElementById('saveContractBtn');
const loadDemoBtn = document.getElementById('loadDemoBtn');
const contractMsg = document.getElementById('contractMsg');

/* Login cards */
const policeLogin = document.getElementById('policeLogin');
const courtLogin  = document.getElementById('courtLogin');
const policeStationId = document.getElementById('policeStationId');
const policePass  = document.getElementById('policePass');
const courtId     = document.getElementById('courtId');
const courtPass   = document.getElementById('courtPass');
const policeLoginBtn = document.getElementById('policeLoginBtn');
const policeCancelBtn= document.getElementById('policeCancelBtn');
const courtLoginBtn  = document.getElementById('courtLoginBtn');
const courtCancelBtn = document.getElementById('courtCancelBtn');

/* Portals */
const policePage = document.getElementById('policePage');
const courtPage  = document.getElementById('courtPage');
const publicPage = document.getElementById('publicPage');
const resultsCard = document.getElementById('resultsCard');
const resultsOutput = document.getElementById('resultsOutput');

/* Logout buttons inside portals */
const policeLogoutBtn = document.getElementById('policeLogoutBtn');
const courtLogoutBtn  = document.getElementById('courtLogoutBtn');

/* Police fields */
const p_aadhaar=document.getElementById('p_aadhaar');
const p_accused=document.getElementById('p_accused');
const p_detail=document.getElementById('p_detail');
const p_location=document.getElementById('p_location');
const p_officer=document.getElementById('p_officer');
const p_crime=document.getElementById('p_crime');
const p_reg=document.getElementById('p_reg');
const p_unique=document.getElementById('p_unique');
const p_evidence=document.getElementById('p_evidence');
const registerBtn=document.getElementById('registerBtn');
const clearPoliceBtn=document.getElementById('clearPoliceBtn');
const policeTrackInput=document.getElementById('policeTrackInput');
const policeTrackBtn=document.getElementById('policeTrackBtn');

/* Court fields */
const courtSelect=document.getElementById('courtSelect');
const courtManual=document.getElementById('courtManual');
const courtJudgment=document.getElementById('courtJudgment');
const courtClosing=document.getElementById('courtClosing');
const submitJudgmentBtn=document.getElementById('submitJudgmentBtn');
const addReviewBtn=document.getElementById('addReviewBtn');
const courtTrackInput=document.getElementById('courtTrackInput');
const courtTrackBtn=document.getElementById('courtTrackBtn');

/* Public */
const publicInput=document.getElementById('publicInput');
const publicTrackBtn=document.getElementById('publicTrackBtn');
const publicOutput=document.getElementById('publicOutput');

/* ========= Helpers ========= */
const methodExists = (name)=> contract?.methods && contract.methods[name];
const tryCall = async (fn, args=[]) => {
  try { return await fn(...args).call(); } catch(_){ return null; }
};
const saveToLocal = ()=>{
  localStorage.setItem('evi_addr', contractAddrInput.value.trim());
  localStorage.setItem('evi_abi', contractAbiInput.value.trim());
};
const loadFromLocal = ()=>{
  const a = localStorage.getItem('evi_addr')||'';
  const abi = localStorage.getItem('evi_abi')||'';
  if(a) contractAddrInput.value=a;
  if(abi) contractAbiInput.value=abi;
  if(a||abi) contractMsg.innerText='Loaded last used values into the form.';
};

function isAuthed(role){ return sessionStorage.getItem(AUTH_KEYS[role]) === '1'; }
function setAuthed(role, val){ sessionStorage.setItem(AUTH_KEYS[role], val ? '1':'0'); }

/* show/hide portals or login cards */
function showOnly(el){ el.classList.add('active'); }
function hideAllPortalsAndLogins(){
  [policePage,courtPage,publicPage].forEach(p=>p.classList.remove('active'));
  [policeLogin,courtLogin].forEach(l=>l.classList.remove('active'));
}
function routeForRole(role){
  hideAllPortalsAndLogins();
  resultsCard.style.display = role ? 'block' : 'none';

  if(!role){ return; }

  if(role==='public'){
    showOnly(publicPage);
    return;
  }

  // Require wallet for police/court
  if(!web3 || !accounts || !accounts.length){
    alert('Connect wallet first.');
    return;
  }

  if(role==='police'){
    if(isAuthed('police')) { showOnly(policePage); }
    else { showOnly(policeLogin); }
  }

  if(role==='court'){
    if(isAuthed('court')) { showOnly(courtPage); }
    else { showOnly(courtLogin); }
  }
}

/* Evidence enumeration helpers (safe fallbacks) */
async function detectAnyEnumeration(){
  if(!contract) return [];
  if(methodExists('getAllEvidenceIds')){
    const list = await tryCall(contract.methods.getAllEvidenceIds);
    return Array.isArray(list) ? list : [];
  }
  // no enumeration method; return cache
  return localEvidenceCache;
}

async function refreshEvidenceSelect(){
  if(!contract){ courtSelect.innerHTML='<option value="">-- none --</option>'; return; }
  let ids = [];
  if(methodExists('getAllEvidenceIds')){
    try{ ids = await contract.methods.getAllEvidenceIds().call(); }
    catch(_){ ids = []; }
  } else {
    ids = localEvidenceCache || [];
  }
  courtSelect.innerHTML = '<option value="">-- none --</option>';
  (ids||[]).forEach(id=>{
    const opt=document.createElement('option');
    opt.value=id; opt.text=id;
    courtSelect.appendChild(opt);
  });
}

/* ========= Role routing ========= */
roleSel.addEventListener('change', ()=> routeForRole(roleSel.value));
showPublicBtn.addEventListener('click', ()=>{ roleSel.value='public'; routeForRole('public'); });

/* ========= Login flows ========= */
policeLoginBtn.addEventListener('click', ()=>{
  const pass = policePass.value.trim();
  if(!policeStationId.value.trim()) return alert('Enter Station ID');
  if(pass !== DEMO_POLICE_PASS) return alert('Wrong passcode');
  setAuthed('police', true);
  policePass.value='';
  routeForRole('police');
});
policeCancelBtn.addEventListener('click', ()=>{ roleSel.value=''; routeForRole(''); });
policeLogoutBtn.addEventListener('click', ()=>{
  setAuthed('police', false);
  alert('Logged out of Police portal');
  routeForRole('police');
});

courtLoginBtn.addEventListener('click', ()=>{
  const pass = courtPass.value.trim();
  if(!courtId.value.trim()) return alert('Enter Court ID');
  if(pass !== DEMO_COURT_PASS) return alert('Wrong passcode');
  setAuthed('court', true);
  courtPass.value='';
  routeForRole('court');
});
courtCancelBtn.addEventListener('click', ()=>{ roleSel.value=''; routeForRole(''); });
courtLogoutBtn.addEventListener('click', ()=>{
  setAuthed('court', false);
  alert('Logged out of Court portal');
  routeForRole('court');
});

/* ========= Wallet ========= */
connectBtn.addEventListener('click', async ()=>{
  if(!window.ethereum) return alert('MetaMask not available.');
  try{
    await window.ethereum.request({method:'eth_requestAccounts'});
    web3=new Web3(window.ethereum);
    accounts=await web3.eth.getAccounts();
    acctSpan.innerText = accounts[0].slice(0,6)+'...'+accounts[0].slice(-4);
    alert('Wallet connected: '+accounts[0]);
    // If a role is already selected, re-route (may unlock portal now)
    if(roleSel.value) routeForRole(roleSel.value);
  }catch(e){ alert('Connect failed: '+(e.message||e)); }
});
disconnectBtn.addEventListener('click', ()=>{
  web3=null; accounts=null; contract=null;
  acctSpan.innerText='not connected';
  alert('Disconnected locally. (Lock MetaMask to fully disconnect)');
  // force portals requiring wallet to bounce back to login prompt
  if(roleSel.value==='police' || roleSel.value==='court') routeForRole(roleSel.value);
});

/* ========= Contract load/test ========= */
saveContractBtn.addEventListener('click', async ()=>{
  const addr = contractAddrInput.value.trim();
  if(!addr) return alert('Paste contract address first.');
  let abiText = contractAbiInput.value.trim();
  try{ CONTRACT_ABI = JSON.parse(abiText); }catch(e){ return alert('ABI parse error: '+e.message); }
  CONTRACT_ADDRESS = addr;
  try{
    if(!web3) await connectBtn.click();
    contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
    const ok = await detectAnyEnumeration();
    contractMsg.innerText = 'Contract OK. Evidence entries detected: '+(ok?.length ?? 'unknown');
    saveToLocal();
    await refreshEvidenceSelect();
  }catch(e){ console.error(e); alert('Contract init failed: '+(e.message||e)); }
});

loadDemoBtn.addEventListener('click', loadFromLocal);

/* ========= Optional: wire simple placeholders so clicks don't error ========= */
registerBtn.addEventListener('click', ()=>{
  if(!contract || !accounts?.length){ alert('Connect wallet and set contract first.'); return; }
  alert('Register flow not wired in this snippet. Hook up your contract method here.');
});
clearPoliceBtn.addEventListener('click', ()=>{
  [p_aadhaar,p_accused,p_detail,p_location,p_officer,p_crime,p_reg,p_unique,p_evidence].forEach(el=> el.value='');
});
policeTrackBtn.addEventListener('click', ()=>{ resultsCard.style.display='block'; resultsOutput.innerText='(Police track) Implement your tracking call here.'; });
courtTrackBtn.addEventListener('click',  ()=>{ resultsCard.style.display='block'; resultsOutput.innerText='(Court track) Implement your tracking call here.'; });
publicTrackBtn.addEventListener('click', ()=>{ resultsOutput.innerText='(Public track) Implement your tracking call here.'; resultsCard.style.display='block'; });

/* ========= Initial load ========= */
window.addEventListener('load', ()=>{
  loadFromLocal();
  // restore authed flags (sessionStorage survives reload in same tab)
  routeForRole(roleSel.value || '');
});
</script>
</body>
</html>
